<!DOCTYPE html>
<html lang="zh-CN">
    <!-- title -->




<!-- keywords -->




<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" >
    <meta name="author" content="Zhangguanzhang">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Zhangguanzhang">
    
    <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    
    <meta name="description" content="记录生活点滴">
    <meta name="description" content="市面上很多kubeadm的文章都是错误示范或者不够详细，大多数都没写系统设置之类的就直接kubeadm init导致很多跟着做的人会报错 我期望看到本文的读者最少具备以下知识:  Linux一些目录规范和systemd 学过一点docker 懂dns和&#x2F;etc&#x2F;hosts、curl互相结合来测试一些web的接口响应状态 不要求github有自己项目，至少会浏览github  本教学将以下列节点数与">
<meta property="og:type" content="article">
<meta property="og:title" content="[长期更新]--应大多数人要求写下kubeadm的基础使用">
<meta property="og:url" content="http://zhangguanzhang.github.io/2019/11/24/kubeadm-base-use/">
<meta property="og:site_name" content="Zhangguanzhang">
<meta property="og:description" content="市面上很多kubeadm的文章都是错误示范或者不够详细，大多数都没写系统设置之类的就直接kubeadm init导致很多跟着做的人会报错 我期望看到本文的读者最少具备以下知识:  Linux一些目录规范和systemd 学过一点docker 懂dns和&#x2F;etc&#x2F;hosts、curl互相结合来测试一些web的接口响应状态 不要求github有自己项目，至少会浏览github  本教学将以下列节点数与">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-11-24T19:36:53.000Z">
<meta property="article:modified_time" content="2020-09-18T02:35:58.000Z">
<meta property="article:author" content="Zhangguanzhang">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="kubeadm">
<meta name="twitter:card" content="summary">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    
    <title>[长期更新]--应大多数人要求写下kubeadm的基础使用 · zhangguanzhang&#39;s Blog</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href= "/css/style.css?v=20180824" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="stylesheet" href= "/css/mobile.css?v=20180824" media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href= "/assets/favicon.ico" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script" />
    <link rel="preload" href="/scripts/main.js" as="script" />
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
<meta name="generator" content="Hexo 4.2.0"></head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/" >zhangguanzhang&#39;s Blog</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">[长期更新]--应大多数人要求写下kubeadm的基础使用</a>
            </div>
    </div>
    
    <a class="home-link" href=/>zhangguanzhang's Blog</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style="







height:50vh;
">
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            [长期更新]--应大多数人要求写下kubeadm的基础使用
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "k8s">k8s</a>
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "kubeadm">kubeadm</a>
    
</div>
                
                
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">8.8k</span>阅读时长: <span class="post-count reading-time">42 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2019/11/24</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <p>市面上很多kubeadm的文章都是错误示范或者不够详细，大多数都没写系统设置之类的就直接<code>kubeadm init</code>导致很多跟着做的人会报错</p>
<p>我期望看到本文的读者最少具备以下知识:</p>
<ul>
<li>Linux一些目录规范和systemd</li>
<li>学过一点docker</li>
<li>懂dns和/etc/hosts、curl互相结合来测试一些web的接口响应状态</li>
<li>不要求github有自己项目，至少会浏览github</li>
</ul>
<p>本教学将以下列节点数与规格来进行部署Kubernetes集群,系统<code>CentOS 7.6+</code>，有条件<code>7.8</code>，不要使用centos7.4以及一下，容器技术依赖于内核技术，低版本系统部署和运行后问题会非常多。有读者用debian10测试过了，apt系列的ubuntu应该16.04以上也行。总之本教程使用yum系列的系统和apt的系统</p>
<table>
<thead>
<tr>
<th align="left">IP</th>
<th align="center">Hostname</th>
<th align="center">role</th>
<th align="center">CPU</th>
<th align="center">Memory</th>
</tr>
</thead>
<tbody><tr>
<td align="left">172.19.0.2</td>
<td align="center">K8S-M1</td>
<td align="center">master</td>
<td align="center">4</td>
<td align="center">8G</td>
</tr>
<tr>
<td align="left">172.19.0.3</td>
<td align="center">K8S-M2</td>
<td align="center">master</td>
<td align="center">4</td>
<td align="center">8G</td>
</tr>
<tr>
<td align="left">172.19.0.4</td>
<td align="center">K8S-M3</td>
<td align="center">master</td>
<td align="center">4</td>
<td align="center">8G</td>
</tr>
<tr>
<td align="left">172.19.0.5</td>
<td align="center">K8S-N1</td>
<td align="center">node</td>
<td align="center">2</td>
<td align="center">4G</td>
</tr>
</tbody></table>
<blockquote>
<ul>
<li>kubeadm好像要求最低配置2c2g还是多少来着，云主机的话如果是新手最好在同一个vpc内的机器整</li>
<li>所有操作全部用root使用者进行，系统盘尽量大点，不然到时候镜像多了例如到了85%会被gc回收镜像</li>
<li>高可用一般建议大于等于3台的奇数台,我使用3台<code>master</code>来做高可用，如果是虚机的话最好不要克隆，所以机器都要是静态ip，别配置dhcp</li>
<li>一台也可以，但是差距不大，差异性我会在文章中注明的，并且单台master的话其他的master ip不用写即可</li>
</ul>
</blockquote>
<h2 id="事前准备-每台机器"><a href="#事前准备-每台机器" class="headerlink" title="事前准备(每台机器)"></a>事前准备(每台机器)</h2><h3 id="系统层面设置"><a href="#系统层面设置" class="headerlink" title="系统层面设置"></a>系统层面设置</h3><p>假设系统是刚用官方iso安装完成未作任何配置(网络和dns自行去配置)，apt系列的系统可能需要自行配制下国内的包管理源。对于各系统的差异性我会在命令前加系统区别开，没有声明系统的就是通用的命名</p>
<ul>
<li><p>所有防火墙与SELinux 已关闭。如CentOS：<br>否则后续 K8S 挂载目录时可能报错 Permission denied，有些云厂商的ip是被NetworkManager纳管的(例如青云)，停了它会网络不通，可以不停。<br>yum系列系统:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld NetworkManager</span><br><span class="line">#关闭selinux</span><br><span class="line">setenforce 0</span><br><span class="line">sed -ri &#39;&#x2F;^[^#]*SELINUX&#x3D;&#x2F;s#&#x3D;.+$#&#x3D;disabled#&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br></pre></td></tr></table></figure>
<p>apt系列系统:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw disable</span><br></pre></td></tr></table></figure>
<p>设置时区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;Asia&#x2F;Shanghai &#x2F;etc&#x2F;localtime</span><br></pre></td></tr></table></figure></li>
<li><p>关闭 dnsmasq (可选)<br>linux 系统开启了 dnsmasq 后(如 GUI 环境)，将系统 DNS Server 设置为 127.0.0.1，这会导致 docker 容器无法解析域名，需要关闭它</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> --now dnsmasq</span><br></pre></td></tr></table></figure></li>
<li><p>核查下<code>cat /etc/resolv.conf</code><br>coredns会proxy非集群的search(也就是pod访问外网，这个就是集群外的解析)到它自己的<code>/etc/resolv.conf</code>里的<code>nameserver</code>，这个文件内容会和宿主机一样，有的apt系统会把dns解析到<code>127.0.0.xx</code>本地跑一个dns server，代理本地的所有dns请求到公网，这样会导致pod无法解析外网的域名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">search lan</span><br><span class="line">nameserver 127.0.0.xx</span><br></pre></td></tr></table></figure>
<p>文件有上面内容的话自行配置下，dns上游改成公网的dns或者内网的dns server，去掉search行</p>
</li>
<li><p>Kubernetes 建议关闭系统Swap,在<code>所有机器</code>使用以下指令关闭swap并注释掉<code>/etc/fstab</code>中swap的行，不想关闭可以不执行，后面会应对的配置选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">sed -ri <span class="string">'/^[^#]*swap/s@^@#@'</span> /etc/fstab</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装一些基础依赖和工具<br>yum系列系统:</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release -y</span><br><span class="line">yum install -y \</span><br><span class="line">    curl \</span><br><span class="line">    wget \</span><br><span class="line">    git \</span><br><span class="line">    conntrack-tools \</span><br><span class="line">    psmisc \</span><br><span class="line">    nfs-utils \</span><br><span class="line">    jq \</span><br><span class="line">    socat \</span><br><span class="line">    ebtables \</span><br><span class="line">    ethtool \</span><br><span class="line">    util-linux \</span><br><span class="line">    bash-completion \</span><br><span class="line">    ipset \</span><br><span class="line">    ipvsadm \</span><br><span class="line">    conntrack \</span><br><span class="line">    libseccomp \</span><br><span class="line">    net-tools \</span><br><span class="line">    crontabs \</span><br><span class="line">    sysstat \</span><br><span class="line">    unzip \</span><br><span class="line">    iftop \</span><br><span class="line">    nload \</span><br><span class="line">    strace \</span><br><span class="line">    <span class="built_in">bind</span>-utils \</span><br><span class="line">    tcpdump \</span><br><span class="line">    telnet \</span><br><span class="line">    lsof \</span><br><span class="line">    htop</span><br></pre></td></tr></table></figure>

<p>apt系列系统:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get install -y wget \</span><br><span class="line">  git \</span><br><span class="line">  psmisc \</span><br><span class="line">  nfs-kernel-server \</span><br><span class="line">  nfs-common \</span><br><span class="line">  jq \</span><br><span class="line">  socat \</span><br><span class="line">  bash-completion \</span><br><span class="line">  ipset \</span><br><span class="line">  ipvsadm \</span><br><span class="line">  conntrack \</span><br><span class="line">  libseccomp2 \</span><br><span class="line">  net-tools \</span><br><span class="line">  cron \</span><br><span class="line">  sysstat \</span><br><span class="line">  unzip \</span><br><span class="line">  dnsutils \</span><br><span class="line">  tcpdump \</span><br><span class="line">  telnet \</span><br><span class="line">  lsof \</span><br><span class="line">  htop \</span><br><span class="line">  curl \</span><br><span class="line">  apt-transport-https \</span><br><span class="line">  ca-certificates</span><br></pre></td></tr></table></figure>

<ul>
<li>如果集群kube-proxy想使用ipvs模式的话需要开机加载下列模块儿，按照规范使用<code>systemd-modules-load</code>来加载而不是在<code>/etc/rc.local</code>里写modprobe<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">:&gt; &#x2F;etc&#x2F;modules-load.d&#x2F;ipvs.conf</span><br><span class="line">module&#x3D;(</span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">br_netfilter</span><br><span class="line">  )</span><br><span class="line">for kernel_module in $&#123;module[@]&#125;;do</span><br><span class="line">    &#x2F;sbin&#x2F;modinfo -F filename $kernel_module |&amp; grep -qv ERROR &amp;&amp; echo $kernel_module &gt;&gt; &#x2F;etc&#x2F;modules-load.d&#x2F;ipvs.conf || :</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
apt系列的系统先使用<code>systemctl cat systemd-modules-load</code>看下有没有<code>Install</code>段，没有则执行下面<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat&gt;&gt;&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;systemd-modules-load.service&lt;&lt;EOF</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
启动该模块管理服务<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now systemd-modules-load.service</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>上面如果systemctl enable命令报错可以systemctl status -l systemd-modules-load.service看看哪个内核模块加载不了,在/etc/modules-load.d/ipvs.conf里注释掉它再enable试试<br>确认内核模块加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ lsmod | grep ip_v</span><br><span class="line">ip_vs_sh               12688  0 </span><br><span class="line">ip_vs_wrr              12697  0 </span><br><span class="line">ip_vs_rr               12600  11 </span><br><span class="line">ip_vs                 145497  17 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span><br><span class="line">nf_conntrack          133095  7 ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_ipv4</span><br><span class="line">libcrc32c              12644  3 ip_vs,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure>

<ul>
<li><code>所有机器</code>需要设定<code>/etc/sysctl.d/k8s.conf</code>的系统参数，目前对ipv6支持不怎么好，所以里面也关闭ipv6了。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 = 1</span><br><span class="line">net.ipv4.neigh.default.gc_stale_time = 120</span><br><span class="line">net.ipv4.conf.all.rp_filter = 0</span><br><span class="line">net.ipv4.conf.default.rp_filter = 0</span><br><span class="line">net.ipv4.conf.default.arp_announce = 2</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 1024</span><br><span class="line">net.ipv4.tcp_synack_retries = 2</span><br><span class="line"><span class="comment"># 要求iptables不对bridge的数据进行处理</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 1</span><br><span class="line">net.netfilter.nf_conntrack_max = 2310720</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">fs.file-max = 52706963</span><br><span class="line">fs.nr_open = 52706963</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>
如果选择关闭swap也要在内核里关闭，不关闭可以不执行<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'vm.swappiness = 0'</span> &gt;&gt; /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>如果kube-proxy使用ipvs的话为了防止timeout需要设置下tcp参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;&gt; /etc/sysctl.d/k8s.conf</span><br><span class="line"><span class="comment"># https://github.com/moby/moby/issues/31208 </span></span><br><span class="line"><span class="comment"># ipvsadm -l --timout</span></span><br><span class="line"><span class="comment"># 修复ipvs模式下长连接timeout问题 小于900即可</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 30</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 10</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>

<ul>
<li><p>优化设置 journal 日志相关，避免日志重复搜集，浪费系统资源。修改systemctl启动的最小文件打开数量。关闭ssh反向dns解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面两句apt系列系统没有，执行不影响</span></span><br><span class="line">sed -ri <span class="string">'s/^\$ModLoad imjournal/#&amp;/'</span> /etc/rsyslog.conf</span><br><span class="line">sed -ri <span class="string">'s/^\$IMJournalStateFile/#&amp;/'</span> /etc/rsyslog.conf</span><br><span class="line"></span><br><span class="line">sed -ri <span class="string">'s/^#(DefaultLimitCORE)=/\1=100000/'</span> /etc/systemd/system.conf</span><br><span class="line">sed -ri <span class="string">'s/^#(DefaultLimitNOFILE)=/\1=100000/'</span> /etc/systemd/system.conf</span><br><span class="line"></span><br><span class="line">sed -ri <span class="string">'s/^#(UseDNS )yes/\1no/'</span> /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>
</li>
<li><p>文件最大打开数，按照规范，在子配置文件写</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat&gt;/etc/security/limits.d/kubernetes.conf&lt;&lt;EOF</span><br><span class="line">*       soft    nproc   131072</span><br><span class="line">*       hard    nproc   131072</span><br><span class="line">*       soft    nofile  131072</span><br><span class="line">*       hard    nofile  131072</span><br><span class="line">root    soft    nproc   131072</span><br><span class="line">root    hard    nproc   131072</span><br><span class="line">root    soft    nofile  131072</span><br><span class="line">root    hard    nofile  131072</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>集群的HA依赖于时间一致性，安装并配置chrony<br>yum:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y chrony</span><br></pre></td></tr></table></figure>
<p>apt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y chrony</span><br></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat&gt;&#x2F;etc&#x2F;chrony.conf&lt;&lt;EOF</span><br><span class="line">server cn.pool.ntp.org iburst minpoll 4 maxpoll 10</span><br><span class="line">server s1b.time.edu.cn iburst minpoll 4 maxpoll 10</span><br><span class="line"># Ignor source level</span><br><span class="line">stratumweight 0</span><br><span class="line"></span><br><span class="line"># Record the rate at which the system clock gains&#x2F;losses time.</span><br><span class="line">driftfile &#x2F;var&#x2F;lib&#x2F;chrony&#x2F;chrony.drift</span><br><span class="line"></span><br><span class="line"># This directive enables kernel synchronisation (every 11 minutes) of the</span><br><span class="line"># real-time clock. Note that it can’t be used along with the &#39;rtcfile&#39; directive.</span><br><span class="line">rtcsync</span><br><span class="line"></span><br><span class="line"># Allow the system clock to be stepped in the first three updates</span><br><span class="line"># if its offset is larger than 1 second.</span><br><span class="line">makestep 1.0 3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Enable hardware timestamping on all interfaces that support it.</span><br><span class="line">#hwtimestamp *</span><br><span class="line"></span><br><span class="line"># Increase the minimum number of selectable sources required to adjust</span><br><span class="line"># the system clock.</span><br><span class="line">#minsources 2</span><br><span class="line"></span><br><span class="line">bindcmdaddress 127.0.0.1</span><br><span class="line"></span><br><span class="line">#bindcmdaddress ::1</span><br><span class="line"></span><br><span class="line"># Specify file containing keys for NTP authentication.</span><br><span class="line">keyfile &#x2F;etc&#x2F;chrony&#x2F;chrony.keys</span><br><span class="line"></span><br><span class="line">logdir &#x2F;var&#x2F;log&#x2F;chrony</span><br><span class="line"># adjust time big than 1 sec will log to file</span><br><span class="line">logchange 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li><p>修改hostname<br>kubelet和kube-proxy上报node信息默认是取hostname的，除非通过<code>--hostname-override</code>指定，这里自行设置hostname</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl <span class="built_in">set</span>-hostname xxx</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker官方的内核检查脚本建议<code>(RHEL7/CentOS7: User namespaces disabled; add &#39;user_namespace.enable=1&#39; to boot command line)</code>，如果是yum系列的系统使用下面命令开启，apt类型的系统不需要<br>yum:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grubby --args=<span class="string">"user_namespace.enable=1"</span> --update-kernel=<span class="string">"<span class="variable">$(grubby --default-kernel)</span>"</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>重启系统</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h3 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h3><ul>
<li>检查系统内核和模块是否适合运行 docker (仅适用于 linux 系统)，该脚本可能因为墙的原因无法生成，可以先去掉重定向看看能不能访问到脚本<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://raw.githubusercontent.com/docker/docker/master/contrib/check-config.sh &gt; check-config.sh</span><br><span class="line">bash ./check-config.sh</span><br></pre></td></tr></table></figure>
现在docker存储驱动都是使用的overlay2(不要使用devicemapper，这个坑非常多)，我们重点关注overlay2是否不是绿色</li>
</ul>
<p>这里我们使用年份命名版本的docker-ce，假设我们要安装<code>v1.18.6</code>的k8s，我们去 <a href="https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG</a> 里进对应版本的<code>CHANGELOG-1.18.md</code>里搜<code>The list of validated docker versions remain</code>查找官方验证过的docker版本，docker版本不一定得在列表里，实际上测试过19.03也能使用(19.03+修复了runc的一个性能bug)，这里我们使用docker官方的安装脚本安装docker(该脚本支持centos和ubuntu)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> VERSION=19.03</span><br><span class="line">curl -fsSL <span class="string">"https://get.docker.com/"</span> | bash -s -- --mirror Aliyun</span><br></pre></td></tr></table></figure>
<ul>
<li><code>所有机器</code>配置加速源并配置docker的启动参数使用systemd,使用systemd是官方的建议,详见 <a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#cgroup-%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#cgroup-%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker/</span><br><span class="line">cat&gt;/etc/docker/daemon.json&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [</span><br><span class="line">      <span class="string">"https://fz5yth0r.mirror.aliyuncs.com"</span>,</span><br><span class="line">      <span class="string">"https://dockerhub.mirrors.nwafu.edu.cn/"</span>,</span><br><span class="line">      <span class="string">"https://mirror.ccs.tencentyun.com"</span>,</span><br><span class="line">      <span class="string">"https://docker.mirrors.ustc.edu.cn/"</span>,</span><br><span class="line">      <span class="string">"https://reg-mirror.qiniu.com"</span>,</span><br><span class="line">      <span class="string">"http://hub-mirror.c.163.com/"</span>,</span><br><span class="line">      <span class="string">"https://registry.docker-cn.com"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</span><br><span class="line">  <span class="string">"storage-opts"</span>: [</span><br><span class="line">    <span class="string">"overlay2.override_kernel_check=true"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span>,</span><br><span class="line">    <span class="string">"max-file"</span>: <span class="string">"3"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>Live Restore Enabled</code>这个千万别开，某些极端情况下容器Dead状态之类的必须重启docker daemon才能解决，开了就只能重启机器解决了</p>
</blockquote>
</li>
</ul>
<ul>
<li>CentOS安装完成后docker需要手动设置docker命令补全：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release bash-completion</span><br></pre></td></tr></table></figure>
<p>apt系列操作为取消文件<code>/etc/bash.bashrc</code>内下面行的注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># enable bash completion in interactive shells</span><br><span class="line">#if ! shopt -oq posix; then</span><br><span class="line">#  if [ -f &#x2F;usr&#x2F;share&#x2F;bash-completion&#x2F;bash_completion ]; then</span><br><span class="line">#    . &#x2F;usr&#x2F;share&#x2F;bash-completion&#x2F;bash_completion</span><br><span class="line">#  elif [ -f &#x2F;etc&#x2F;bash_completion ]; then</span><br><span class="line">#    . &#x2F;etc&#x2F;bash_completion</span><br><span class="line">#  fi</span><br><span class="line">#fi</span><br></pre></td></tr></table></figure>
<p>复制补全脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;share&#x2F;bash-completion&#x2F;completions&#x2F;docker &#x2F;etc&#x2F;bash_completion.d&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li>防止FORWARD的DROP策略影响转发,给docker daemon添加下列参数修正，当然暴力点也可以<code>iptables -P FORWARD ACCEPT</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/systemd/system/docker.service.d/</span><br><span class="line">cat&gt;/etc/systemd/system/docker.service.d/10-docker.conf&lt;&lt;EOF</span><br><span class="line">[Service]</span><br><span class="line">ExecStartPost=/sbin/iptables -I FORWARD -s 0.0.0.0/0 -j ACCEPT</span><br><span class="line">ExecStopPost=/bin/bash -c <span class="string">'/sbin/iptables -D FORWARD -s 0.0.0.0/0 -j ACCEPT &amp;&gt; /dev/null || :'</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>启动docker并看下信息是否正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now docker</span><br><span class="line">docker info</span><br></pre></td></tr></table></figure>
<p>如果enable docker的时候报错开启debug，如何开见 <a href="https://github.com/zhangguanzhang/Kubernetes-ansible/wiki/systemctl-running-debug" target="_blank" rel="noopener">https://github.com/zhangguanzhang/Kubernetes-ansible/wiki/systemctl-running-debug</a></p>
<ul>
<li>物理机的话切到非省电模式,apt系列系统暂时不知道，省电模式cpu频率低，见 <a href="https://zhangguanzhang.github.io/2019/04/28/k8s-java-start-time-not-same/#%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF">https://zhangguanzhang.github.io/2019/04/28/k8s-java-start-time-not-same/#%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tuned-adm profile throughput-performance</span><br></pre></td></tr></table></figure>
<h2 id="kubeadm部署"><a href="#kubeadm部署" class="headerlink" title="kubeadm部署"></a>kubeadm部署</h2></li>
</ul>
<h3 id="安装kubeadm相关"><a href="#安装kubeadm相关" class="headerlink" title="安装kubeadm相关"></a>安装kubeadm相关</h3><p>默认源在国外会无法安装，我们使用国内的镜像源，所有机器都要操作<br>yum:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;/etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>apt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;apt&#x2F;doc&#x2F;apt-key.gpg | apt-key add -</span><br><span class="line">cat&gt;&#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;kubernetes.list&lt;&lt;EOF</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;apt&#x2F; kubernetes-xenial main&quot;</span><br><span class="line">EOF</span><br><span class="line">apt-get update</span><br></pre></td></tr></table></figure>

<h4 id="master部分"><a href="#master部分" class="headerlink" title="master部分"></a>master部分</h4><p>k8s的node就是kubelet+cri(一般是docker)，kubectl是一个agent读取kubeconfig去访问kube-apiserver来操作集群，kubeadm是部署，所以master节点需要安装三个，node一般不需要kubectl<br>安装相关软件<br>yum:  如果依赖错误，yum命令后面加个<code>--setopt=obsoletes=0</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install -y \</span><br><span class="line">    kubeadm-1.18.9 \</span><br><span class="line">    kubectl-1.18.9 \</span><br><span class="line">    kubelet-1.18.9 \</span><br><span class="line">    --disableexcludes=kubernetes &amp;&amp; \</span><br><span class="line">    systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure>
<p>apt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y \</span><br><span class="line">  kubeadm&#x3D;1.18.9-00 \</span><br><span class="line">  kubectl-1.18.9-00 \</span><br><span class="line">  kubelet-1.18.9-00</span><br></pre></td></tr></table></figure>

<h4 id="node"><a href="#node" class="headerlink" title="node"></a>node</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y \</span><br><span class="line">    kubeadm-1.18.9 \</span><br><span class="line">    kubelet-1.18.9 \</span><br><span class="line">    --disableexcludes&#x3D;kubernetes &amp;&amp; \</span><br><span class="line">    systemctl enable kubelet</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y \</span><br><span class="line">  kubeadm&#x3D;1.18.9-00 \</span><br><span class="line">  kubelet-1.18.9-00</span><br></pre></td></tr></table></figure>
<h3 id="配置kubelet的参数方法-有需要的话"><a href="#配置kubelet的参数方法-有需要的话" class="headerlink" title="配置kubelet的参数方法(有需要的话)"></a>配置kubelet的参数方法(有需要的话)</h3><p>查看kubelet的systemd文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl cat kubelet</span><br></pre></td></tr></table></figure>
<p>我们可以看到<code>/etc/sysconfig/kubelet</code>是<code>EnvironmentFile</code>，里面注释也写明了我们应该在该文件里写<code>KUBELET_EXTRA_ARGS</code>来给kubelet配置运行参数,下面是个例子，具体参数啥的可以<code>kubelet --help</code>看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;sysconfig&#x2F;kubelet&lt;&lt;EOF</span><br><span class="line">KUBELET_EXTRA_ARGS&#x3D;&quot;--xxx&#x3D;yyy --aaa&#x3D;bbb&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>文件<code>/var/lib/kubelet/kubeadm-flags.env</code>也一样</p>
<p>如果自己离线的话这块儿实际上就是二进制文件+systemd，可以自己去剥离成离线，同时systemd不要完全抄官方的，可以简单写，例如不要像kubelet的systemd那样拼变量</p>
<h3 id="配置HA-所有机器-单个master跳过此步"><a href="#配置HA-所有机器-单个master跳过此步" class="headerlink" title="配置HA,所有机器(单个master跳过此步)"></a>配置HA,所有机器(单个master跳过此步)</h3><p>关于HA我博客 <a href="https://zhangguanzhang.github.io/2019/03/11/k8s-ha/">https://zhangguanzhang.github.io/2019/03/11/k8s-ha/</a> 说得很清楚，这里我用nginx实现local proxy来玩(配置文件来源于kubespray)，因为localproxy是每台机器上的，可以不用SLB和无视在云上vpc里无法使用vip的限制，需要每个机器上运行nginx实现<br>每台机器(master+node)配置hosts</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/etc/hosts &lt;&lt; EOF</span><br><span class="line">127.0.0.1 apiserver.k8s.local</span><br><span class="line">172.19.0.2 apiserver01.k8s.local</span><br><span class="line">172.19.0.3 apiserver02.k8s.local</span><br><span class="line">172.19.0.4 apiserver03.k8s.local</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>每台机器(master+node)生成配置文件，上面的三个hosts可以不写，不写的话下面配置文件里的域名得使用ip即可，但是这样更改ip需要重新加载，所以推荐还是写域名。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes</span><br><span class="line">cat &gt; /etc/kubernetes/nginx.conf &lt;&lt; EOF</span><br><span class="line">error_log stderr notice;</span><br><span class="line"></span><br><span class="line">worker_processes 2;</span><br><span class="line">worker_rlimit_nofile 130048;</span><br><span class="line">worker_shutdown_timeout 10s;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  multi_accept on;</span><br><span class="line">  use epoll;</span><br><span class="line">  worker_connections 16384;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">  upstream kube_apiserver &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    server apiserver01.k8s.local:6443;</span><br><span class="line">    server apiserver02.k8s.local:6443;</span><br><span class="line">    server apiserver03.k8s.local:6443;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">    listen        8443;</span><br><span class="line">    proxy_pass    kube_apiserver;</span><br><span class="line">    proxy_timeout 10m;</span><br><span class="line">    proxy_connect_timeout 1s;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">  aio threads;</span><br><span class="line">  aio_write on;</span><br><span class="line">  tcp_nopush on;</span><br><span class="line">  tcp_nodelay on;</span><br><span class="line"></span><br><span class="line">  keepalive_timeout 75s;</span><br><span class="line">  keepalive_requests 100;</span><br><span class="line">  reset_timedout_connection on;</span><br><span class="line">  server_tokens off;</span><br><span class="line">  autoindex off;</span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">    listen 8081;</span><br><span class="line">    location /healthz &#123;</span><br><span class="line">      access_log off;</span><br><span class="line">      <span class="built_in">return</span> 200;</span><br><span class="line">    &#125;</span><br><span class="line">    location /stub_status &#123;</span><br><span class="line">      stub_status on;</span><br><span class="line">      access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>因为localproxy是每台机器上的，可以不用SLB和vpc无法使用vip的限制，这里我使用容器运行nginx，当然自己也可以写成staticPod的yaml在init的阶段放入目录里</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run --restart=always \</span><br><span class="line">    -v /etc/kubernetes/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">    -v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">    --name k8s \</span><br><span class="line">    --net host \</span><br><span class="line">    -d \</span><br><span class="line">    nginx:alpine</span><br></pre></td></tr></table></figure>

<h3 id="配置集群信息-第一个master上配置"><a href="#配置集群信息-第一个master上配置" class="headerlink" title="配置集群信息(第一个master上配置)"></a>配置集群信息(第一个master上配置)</h3><ul>
<li>打印默认init的配置信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; initconfig.yaml</span><br></pre></td></tr></table></figure>
我们看下默认init的集群参数<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-m1</span></span><br><span class="line">  <span class="attr">taints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.16.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
我们主要关注和只保留<code>ClusterConfiguration</code>的段，然后修改下，可以参考下列的<code>v1beta2</code>文档,如果是低版本可能是v1beta1，某些字段和新的是不一样的，自行查找godoc看<br><a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#hdr-Basics" target="_blank" rel="noopener">https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#hdr-Basics</a><br><a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2" target="_blank" rel="noopener">https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2</a><br><a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#pkg-constants" target="_blank" rel="noopener">https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#pkg-constants</a><br><a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#ClusterConfiguration" target="_blank" rel="noopener">https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#ClusterConfiguration</a><br>ip啥的自行更改成和自己的一致，cidr不懂咋计算就别乱改。controlPlaneEndpoint写域名(内网没dns所有机器写hosts也行)或者SLB，VIP，原因和注意事项见 <a href="https://zhangguanzhang.github.io/2019/03/11/k8s-ha/">https://zhangguanzhang.github.io/2019/03/11/k8s-ha/</a> 这个文章我把HA解释得很清楚了，不要再问我了，下面是最终的yaml<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.aliyuncs.com/k8sxio</span></span><br><span class="line"><span class="comment">#kubernetesVersion: v1.18.9 # 如果镜像列出的版本不对就这里写正确版本号</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">networking:</span> <span class="comment">#https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#Networking</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">apiserver.k8s.local:8443</span> <span class="comment"># 单个master的话写master的ip或者不写</span></span><br><span class="line"><span class="attr">apiServer:</span> <span class="comment"># https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#APIServer</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line">  <span class="attr">extraArgs:</span></span><br><span class="line">    <span class="attr">authorization-mode:</span> <span class="string">"Node,RBAC"</span></span><br><span class="line">    <span class="attr">enable-admission-plugins:</span> <span class="string">"NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeClaimResize,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,Priority,PodPreset"</span></span><br><span class="line">    <span class="attr">runtime-config:</span> <span class="string">api/all=true,settings.k8s.io/v1alpha1=true</span></span><br><span class="line">    <span class="attr">storage-backend:</span> <span class="string">etcd3</span></span><br><span class="line">    <span class="attr">etcd-servers:</span> <span class="string">https://172.19.0.2:2379,https://172.19.0.3:2379,https://172.19.0.4:2379</span></span><br><span class="line">  <span class="attr">certSANs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span> <span class="comment"># service cidr的第一个ip</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="comment"># 多个master的时候负载均衡出问题了能够快速使用localhost调试</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apiserver.k8s.local</span> <span class="comment"># 负载均衡的域名或者vip</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.4</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apiserver01.k8s.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apiserver02.k8s.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apiserver03.k8s.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubernetes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubernetes.default</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubernetes.default.svc</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubernetes.default.svc.cluster.local</span></span><br><span class="line">  <span class="attr">extraVolumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">    <span class="attr">mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">localtime</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">controllerManager:</span> <span class="comment"># https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#ControlPlaneComponent</span></span><br><span class="line">  <span class="attr">extraArgs:</span></span><br><span class="line">    <span class="attr">bind-address:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line">    <span class="attr">experimental-cluster-signing-duration:</span> <span class="string">876000h</span></span><br><span class="line">  <span class="attr">extraVolumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">    <span class="attr">mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">localtime</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line">  <span class="attr">extraArgs:</span></span><br><span class="line">    <span class="attr">bind-address:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line">  <span class="attr">extraVolumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">    <span class="attr">mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">localtime</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">dns:</span> <span class="comment"># https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#DNS</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">CoreDNS</span> <span class="comment"># or kube-dns</span></span><br><span class="line">  <span class="attr">imageRepository:</span> <span class="string">coredns</span> <span class="comment"># azk8s.cn已失效,此处使用上面的ns下镜像，使用dockerhub上coredns官方镜像，</span></span><br><span class="line">  <span class="attr">imageTag:</span> <span class="number">1.6</span><span class="number">.9</span></span><br><span class="line"><span class="attr">etcd:</span> <span class="comment"># https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#Etcd</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="comment">#imageRepository: quay.io/coreos #取消注释使用quay.io，这里使用registry.aliyuncs.com/k8sxio的</span></span><br><span class="line">    <span class="attr">imageTag:</span> <span class="string">v3.4.10</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line">    <span class="attr">serverCertSANs:</span> <span class="comment"># server和peer的localhost,127,::1都默认自带的不需要写</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.4</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">etcd01.k8s.local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">etcd02.k8s.local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">etcd03.k8s.local</span></span><br><span class="line">    <span class="attr">peerCertSANs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.4</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">etcd01.k8s.local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">etcd02.k8s.local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">etcd03.k8s.local</span></span><br><span class="line">    <span class="attr">extraArgs:</span> <span class="comment"># 暂时没有extraVolumes</span></span><br><span class="line">      <span class="attr">auto-compaction-retention:</span> <span class="string">"1h"</span></span><br><span class="line">      <span class="attr">max-request-bytes:</span> <span class="string">"33554432"</span></span><br><span class="line">      <span class="attr">quota-backend-bytes:</span> <span class="string">"8589934592"</span></span><br><span class="line">      <span class="attr">enable-v2:</span> <span class="string">"false"</span> <span class="comment"># disable etcd v2 api</span></span><br><span class="line">  <span class="comment"># external: //外部etcd的时候这样配置 https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#Etcd</span></span><br><span class="line">    <span class="comment"># endpoints:</span></span><br><span class="line">    <span class="comment"># - "https://172.19.0.2:2379"</span></span><br><span class="line">    <span class="comment"># - "https://172.19.0.3:2379"</span></span><br><span class="line">    <span class="comment"># - "https://172.19.0.4:2379"</span></span><br><span class="line">    <span class="comment"># caFile: "/etc/kubernetes/pki/etcd/ca.crt"</span></span><br><span class="line">    <span class="comment"># certFile: "/etc/kubernetes/pki/etcd/etcd.crt"</span></span><br><span class="line">    <span class="comment"># keyFile: "/etc/kubernetes/pki/etcd/etcd.key"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span> <span class="comment"># https://godoc.org/k8s.io/kube-proxy/config/v1alpha1#KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">ipvs</span> <span class="comment"># or iptables</span></span><br><span class="line"><span class="attr">ipvs:</span></span><br><span class="line">  <span class="attr">excludeCIDRs:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">minSyncPeriod:</span> <span class="string">0s</span></span><br><span class="line">  <span class="attr">scheduler:</span> <span class="string">"rr"</span> <span class="comment"># 调度算法</span></span><br><span class="line">  <span class="attr">syncPeriod:</span> <span class="string">15s</span></span><br><span class="line"><span class="attr">iptables:</span></span><br><span class="line">  <span class="attr">masqueradeAll:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">masqueradeBit:</span> <span class="number">14</span></span><br><span class="line">  <span class="attr">minSyncPeriod:</span> <span class="string">0s</span></span><br><span class="line">  <span class="attr">syncPeriod:</span> <span class="string">30s</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span> <span class="comment"># https://godoc.org/k8s.io/kubelet/config/v1beta1#KubeletConfiguration</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">systemd</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">true</span> <span class="comment"># 如果开启swap则设置为false</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<ul>
<li><p>swap的话看最后一行，apiserver的exterArgs是为了开启<code>podPreset</code>，1.16之前且包括1.16，<code>runtime-config</code>的值应该设置为<code>api/all,settings.k8s.io/v1alpha1=true</code></p>
</li>
<li><p>单台master的话把<code>controlPlaneEndpoint</code>的值改为第一个master的ip</p>
</li>
<li><p>etcd的支持版本可以去<a href="https://github.com/kubernetes/kubernetes/blob/master/cmd/kubeadm/app/constants/constants.go#L429-L438" target="_blank" rel="noopener">代码</a>里查看</p>
</li>
<li><p>如果apiserver前面接了云厂商的SLB的话，SLB也配置了公网ip，或者master的机器有公网ip，可以把 公网ip 或者 域名 加到所有的 certSANs 里</p>
</li>
<li><p>上面yaml文件里涉及到ip的地方都更改为自己对应的ip</p>
</li>
<li><p>镜像这部分别像市面上普遍文章里拉mirror然后改名<code>k8s.gcr.io</code>的，系统容量到了一定百分比后会gc掉镜像，你镜像名是<code>k8s.gcr.io</code>会在gc掉后无法拉取镜像。所以不建议这样做，而是设置一个能拉取的repo</p>
</li>
<li><p>kubectl get cs依赖的端口已经准备在1.19里删掉了，所以你监控就别依赖这个了，要开的话在<code>controllerManager</code>和<code>scheduler</code>的<code>extraArgs</code>加<code>port: 1025x</code></p>
<ul>
<li>检查文件是否错误，忽略<code>warning</code>，错误的话会抛出error，没错则会输出到包含字符串<code>kubeadm join xxx</code>啥的</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config initconfig.yaml --dry-run</span><br></pre></td></tr></table></figure>

<ul>
<li>检查镜像是否正确，版本号不正确就把yaml里的<code>kubernetesVersion</code>取消注释写上自己对应的版本号</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list --config initconfig.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>预先拉取镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images pull --config initconfig.yaml <span class="comment"># 下面是输出</span></span><br><span class="line">[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-apiserver:v1.18.9</span><br><span class="line">[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-controller-manager:v1.18.9</span><br><span class="line">[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-scheduler:v1.18.9</span><br><span class="line">[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-proxy:v1.18.9</span><br><span class="line">[config/images] Pulled registry.aliyuncs.com/k8sxio/pause:3.2</span><br><span class="line">[config/images] Pulled registry.aliyuncs.com/k8sxio/etcd:v3.4.10</span><br><span class="line">[config/images] Pulled coredns/coredns:1.6.9</span><br></pre></td></tr></table></figure>

<h3 id="kubeadm-init"><a href="#kubeadm-init" class="headerlink" title="kubeadm init"></a>kubeadm init</h3><h4 id="init-只在第一个master上面操作"><a href="#init-只在第一个master上面操作" class="headerlink" title="init(只在第一个master上面操作)"></a>init(只在第一个master上面操作)</h4><p>下面init只在第一个master上面操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># --experimental-upload-certs 参数的意思为将相关的证书直接上传到etcd中保存，这样省去我们手动分发证书的过程</span><br><span class="line"># 注意在v1.15+版本中，已经变成正式参数，不再是实验性质，之前的版本请使用 --experimental-upload-certs</span><br><span class="line"># https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd&#x2F;blob&#x2F;master&#x2F;CHANGELOG-3.4.md#breaking-changes</span><br><span class="line"></span><br><span class="line">mkdir &#x2F;var&#x2F;lib&#x2F;etcd</span><br><span class="line">chmod 0700 &#x2F;var&#x2F;lib&#x2F;etcd # etcd 3.4.10开始目录权限必须是0700，见上面文档</span><br><span class="line">kubeadm init --config initconfig.yaml --upload-certs</span><br><span class="line"></span><br><span class="line">...下面是输出</span><br><span class="line"></span><br><span class="line">You can now join any number of the control-plane node running the following command on each as root:</span><br><span class="line">--------------master加入的话使用下面命令，此时先别加入</span><br><span class="line">  kubeadm join apiserver.k8s.local:8443 --token d3v79c.i8be79zo2iip15hf \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:455c158a77f60df39a9a0af821950b0468d46571154b638e0a27f0ceee8e1ff5 \</span><br><span class="line">    --control-plane --certificate-key 7a59a81ec3d95bb51bd1757766c5f63263cde5aa499c8dd37c4ef847afcd468b</span><br><span class="line"></span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use</span><br><span class="line">&quot;kubeadm init phase upload-certs --upload-certs&quot; to reload certs afterward.</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line">-----------node加入的话使用下面命令</span><br><span class="line">kubeadm join apiserver.k8s.local:8443 --token d3v79c.i8be79zo2iip15hf \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:455c158a77f60df39a9a0af821950b0468d46571154b638e0a27f0ceee8e1ff5</span><br></pre></td></tr></table></figure>

<p>如果超时了看看是不是kubelet没起来，调试见 <a href="https://github.com/zhangguanzhang/Kubernetes-ansible/wiki/systemctl-running-debug" target="_blank" rel="noopener">https://github.com/zhangguanzhang/Kubernetes-ansible/wiki/systemctl-running-debug</a></p>
<p>记住init后打印的token(记不住或者ttl过期了看后面)，复制kubectl的kubeconfig，kubectl的kubeconfig路径默认是<code>~/.kube/config</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo \cp /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<p>init的yaml信息实际上会存在集群的configmap里，我们可以随时查看，该yaml在其他node和master join的时候会使用到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get cm kubeadm-config -o yaml</span><br></pre></td></tr></table></figure>

<p>如果单个master，也不想整其他的node，需要去掉master节点上的污点，多master一般是+n个node的，所以一般是不需要去掉master上的污点的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>

<h4 id="设置ep的rbac"><a href="#设置ep的rbac" class="headerlink" title="设置ep的rbac"></a>设置ep的rbac</h4><p>kube-apiserver的web健康检查路由有权限，我们需要开放用来监控或者对接SLB的健康检查,yaml文件 <a href="https://github.com/zhangguanzhang/Kubernetes-ansible-base/blob/roles/master/files/healthz-rbac.yml" target="_blank" rel="noopener">https://github.com/zhangguanzhang/Kubernetes-ansible-base/blob/roles/master/files/healthz-rbac.yml</a> 。因为网络因素而无法apply的话就自己下载或者赋值内容后创建文件后apply文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/zhangguanzhang/Kubernetes-ansible-base/roles/master/files/healthz-rbac.yml</span><br></pre></td></tr></table></figure>

<h4 id="配置其他master的k8s管理组件"><a href="#配置其他master的k8s管理组件" class="headerlink" title="配置其他master的k8s管理组件"></a>配置其他master的k8s管理组件</h4><h5 id="手动拷贝-某些低版本不支持上传证书的时候操作-如果前面kubeadm-init的时候加了上传证书选项这步不用执行"><a href="#手动拷贝-某些低版本不支持上传证书的时候操作-如果前面kubeadm-init的时候加了上传证书选项这步不用执行" class="headerlink" title="手动拷贝(某些低版本不支持上传证书的时候操作,如果前面kubeadm init的时候加了上传证书选项这步不用执行)"></a>手动拷贝(某些低版本不支持上传证书的时候操作,如果前面kubeadm init的时候加了上传证书选项这步不用执行)</h5><p><strong>如果前面kubeadm init的时候加了上传证书选项这步不用执行</strong></p>
<p>第一个master上拷贝ca证书到其他master节点上，因为交互输入密码，我们安装sshpass，zhangguanzhang是root密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install sshpass -y</span><br><span class="line"><span class="built_in">alias</span> ssh=<span class="string">'sshpass -p zhangguanzhang ssh -o StrictHostKeyChecking=no'</span></span><br><span class="line"><span class="built_in">alias</span> scp=<span class="string">'sshpass -p zhangguanzhang scp -o StrictHostKeyChecking=no'</span></span><br></pre></td></tr></table></figure>

<p>复制ca证书到其他master节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> 172.19.0.3 172.19.0.4;<span class="keyword">do</span></span><br><span class="line">    ssh <span class="variable">$node</span> <span class="string">'mkdir -p /etc/kubernetes/pki/etcd'</span></span><br><span class="line">    scp -r /etc/kubernetes/pki/ca.* <span class="variable">$node</span>:/etc/kubernetes/pki/</span><br><span class="line">    scp -r /etc/kubernetes/pki/sa.* <span class="variable">$node</span>:/etc/kubernetes/pki/</span><br><span class="line">    scp -r /etc/kubernetes/pki/front-proxy-ca.* <span class="variable">$node</span>:/etc/kubernetes/pki/</span><br><span class="line">    scp -r /etc/kubernetes/pki/etcd/ca.* <span class="variable">$node</span>:/etc/kubernetes/pki/etcd/</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h5 id="其他master-join进来"><a href="#其他master-join进来" class="headerlink" title="其他master join进来"></a>其他master join进来</h5><p>注意是前面init最后输出的命令里选择长串的，不是短串，短传的是node，不是master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/etcd</span><br><span class="line">chmod 0700 /var/lib/etcd</span><br><span class="line">kubeadm join apiserver.k8s.local:8443 --token xxxxxxx \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx \</span><br><span class="line">    --control-plane --certificate-key xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<p>token忘记或者ttl过期了的话可以<code>kubeadm token list</code>查看，可以通过<code>kubeadm token create --print-join-command</code>查看，老版本不确定支持<code>--print-join-command</code>这个选项，不支持的话就不带这个选项创建token，<br>sha256的值可以通过下列命令获取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> \</span><br><span class="line">    /etc/kubernetes/pki/ca.crt | \</span><br><span class="line">    openssl rsa -pubin -outform der 2&gt;/dev/null | \</span><br><span class="line">    openssl dgst -sha256 -hex | sed <span class="string">'s/^.* //'</span></span><br></pre></td></tr></table></figure>

<h4 id="所有master配置kubectl"><a href="#所有master配置kubectl" class="headerlink" title="所有master配置kubectl"></a>所有master配置kubectl</h4><p>准备kubectl的kubeconfig</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo \cp /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<p>设置kubectl的补全脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl completion bash &gt; /etc/bash_completion.d/kubectl</span><br></pre></td></tr></table></figure>

<h4 id="所有master配置etcd备份"><a href="#所有master配置etcd备份" class="headerlink" title="所有master配置etcd备份"></a>所有master配置etcd备份</h4><p>复制出容器里的etcdctl</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp `docker ps -a | awk <span class="string">'/k8s_etcd/&#123;print $1&#125;'</span>`:/usr/<span class="built_in">local</span>/bin/etcdctl /usr/<span class="built_in">local</span>/bin/etcdctl</span><br></pre></td></tr></table></figure>

<p>1.13还是具体哪个版本后k8s默认使用v3 api的etcd，这里我们配置下etcdctl的参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/profile.d/etcd.sh&lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">ETCD_CERET_DIR=/etc/kubernetes/pki/etcd/</span><br><span class="line">ETCD_CA_FILE=ca.crt</span><br><span class="line">ETCD_KEY_FILE=healthcheck-client.key</span><br><span class="line">ETCD_CERT_FILE=healthcheck-client.crt</span><br><span class="line">ETCD_EP=https://172.19.0.2:2379,https://172.19.0.3:2379,https://172.19.0.4:2379</span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> etcd_v2=<span class="string">"etcdctl --cert-file <span class="variable">$&#123;ETCD_CERET_DIR&#125;</span>/<span class="variable">$&#123;ETCD_CERT_FILE&#125;</span> \</span></span><br><span class="line"><span class="string">              --key-file <span class="variable">$&#123;ETCD_CERET_DIR&#125;</span>/<span class="variable">$&#123;ETCD_KEY_FILE&#125;</span>  \</span></span><br><span class="line"><span class="string">              --ca-file <span class="variable">$&#123;ETCD_CERET_DIR&#125;</span>/<span class="variable">$&#123;ETCD_CA_FILE&#125;</span>  \</span></span><br><span class="line"><span class="string">              --endpoints <span class="variable">$ETCD_EP</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> etcd_v3=<span class="string">"ETCDCTL_API=3 \</span></span><br><span class="line"><span class="string">    etcdctl   \</span></span><br><span class="line"><span class="string">   --cert <span class="variable">$&#123;ETCD_CERET_DIR&#125;</span>/<span class="variable">$&#123;ETCD_CERT_FILE&#125;</span> \</span></span><br><span class="line"><span class="string">   --key <span class="variable">$&#123;ETCD_CERET_DIR&#125;</span>/<span class="variable">$&#123;ETCD_KEY_FILE&#125;</span> \</span></span><br><span class="line"><span class="string">   --cacert <span class="variable">$&#123;ETCD_CERET_DIR&#125;</span>/<span class="variable">$&#123;ETCD_CA_FILE&#125;</span> \</span></span><br><span class="line"><span class="string">    --endpoints <span class="variable">$ETCD_EP</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> etcd-<span class="function"><span class="title">ha</span></span>()&#123;</span><br><span class="line">    etcd_v3 endpoint status --write-out=table</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>重新ssh下或者手动加载下环境变量<code>. /etc/profile.d/etcd.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd_v3 endpoint status --write-out=table <span class="comment"># 下面是输出</span></span><br><span class="line">+-------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|        ENDPOINT         |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span><br><span class="line">+-------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">| https://172.19.0.2:2379 | d7380397c3ec4b90 |  3.4.10 |  2.1 MB |      <span class="literal">true</span> |         9 |      85397 |</span><br><span class="line">| https://172.19.0.3:2379 | f776f8545c82d916 |  3.4.10 |  2.1 MB |     <span class="literal">false</span> |         9 |      85405 |</span><br><span class="line">| https://172.19.0.4:2379 | ead42f3e6c9bb295 |  3.4.10 |  2.1 MB |     <span class="literal">false</span> |         9 |      85406 |</span><br><span class="line">+-------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br></pre></td></tr></table></figure>

<p>配置etcd备份脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/etcd</span><br><span class="line">cat&gt;/opt/etcd/etcd_cron.sh&lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line"></span><br><span class="line">:  <span class="variable">$&#123;bak_dir:=/root/&#125;</span> <span class="comment">#缺省备份目录,可以修改成存在的目录</span></span><br><span class="line">:  <span class="variable">$&#123;cert_dir:=/etc/kubernetes/pki/etcd/&#125;</span></span><br><span class="line">:  <span class="variable">$&#123;endpoints:=https://172.19.0.2:2379,https://172.19.0.3:2379,https://172.19.0.4:2379&#125;</span></span><br><span class="line"></span><br><span class="line">bak_prefix=<span class="string">'etcd-'</span></span><br><span class="line">cmd_suffix=<span class="string">'date +%Y-%m-%d-%H:%M'</span></span><br><span class="line">bak_suffix=<span class="string">'.db'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将规范化后的命令行参数分配至位置参数（$1,$2,...)</span></span><br><span class="line">temp=`getopt -n <span class="variable">$0</span> -o c:d: -u -- <span class="string">"<span class="variable">$@</span>"</span>`</span><br><span class="line"></span><br><span class="line">[ $? != 0 ] &amp;&amp; &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'</span></span><br><span class="line"><span class="string">Examples:</span></span><br><span class="line"><span class="string">  # just save once</span></span><br><span class="line"><span class="string">  bash $0 /tmp/etcd.db</span></span><br><span class="line"><span class="string">  # save in contab and  keep 5</span></span><br><span class="line"><span class="string">  bash $0 -c 5</span></span><br><span class="line"><span class="string">    '</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">    &#125;</span><br><span class="line"><span class="built_in">set</span> -- <span class="variable">$temp</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -c 备份保留副本数量</span></span><br><span class="line"><span class="comment"># -d 指定备份存放目录</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">        -c)</span><br><span class="line">            [ -z <span class="string">"<span class="variable">$bak_count</span>"</span> ] &amp;&amp; bak_count=<span class="variable">$2</span></span><br><span class="line">            <span class="built_in">printf</span> -v null %d <span class="string">"<span class="variable">$bak_count</span>"</span> &amp;&gt;/dev/null || \</span><br><span class="line">                &#123; <span class="built_in">echo</span> <span class="string">'the value of the -c must be number'</span>;<span class="built_in">exit</span> 1; &#125;</span><br><span class="line">            <span class="built_in">shift</span> 2</span><br><span class="line">            ;;</span><br><span class="line">        -d)</span><br><span class="line">            [ ! -d <span class="string">"<span class="variable">$2</span>"</span> ] &amp;&amp; mkdir -p <span class="variable">$2</span></span><br><span class="line">            bak_dir=<span class="variable">$2</span></span><br><span class="line">            <span class="built_in">shift</span> 2</span><br><span class="line">            ;;</span><br><span class="line">         *)</span><br><span class="line">            [[ -z <span class="string">"<span class="variable">$1</span>"</span> || <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">'--'</span> ]] &amp;&amp; &#123; <span class="built_in">shift</span>;<span class="built_in">break</span>; &#125;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"Internal error!"</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">etcd_v2</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">    etcdctl --cert-file <span class="variable">$cert_dir</span>/healthcheck-client.crt \</span><br><span class="line">            --key-file  <span class="variable">$cert_dir</span>/healthcheck-client.key \</span><br><span class="line">            --ca-file   <span class="variable">$cert_dir</span>/ca.crt \</span><br><span class="line">        --endpoints <span class="variable">$endpoints</span> <span class="variable">$@</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">etcd_v3</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">    ETCDCTL_API=3 etcdctl   \</span><br><span class="line">       --cert <span class="variable">$cert_dir</span>/healthcheck-client.crt \</span><br><span class="line">       --key  <span class="variable">$cert_dir</span>/healthcheck-client.key \</span><br><span class="line">       --cacert <span class="variable">$cert_dir</span>/ca.crt \</span><br><span class="line">       --endpoints <span class="variable">$endpoints</span> <span class="variable">$@</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">etcd::cron::<span class="function"><span class="title">save</span></span>()&#123;</span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$bak_dir</span>/</span><br><span class="line">    etcd_v3 snapshot save  <span class="variable">$bak_prefix</span>$(<span class="variable">$cmd_suffix</span>)<span class="variable">$bak_suffix</span></span><br><span class="line">    rm_files=`ls -t <span class="variable">$bak_prefix</span>*<span class="variable">$bak_suffix</span> | tail -n +$[bak_count+1]`</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$rm_files</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">        rm -f <span class="variable">$rm_files</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">main</span></span>()&#123;</span><br><span class="line">    [ -n <span class="string">"<span class="variable">$bak_count</span>"</span> ] &amp;&amp; etcd::cron::save || etcd_v3 snapshot save <span class="variable">$@</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main <span class="variable">$@</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>crontab -e添加下面内容自动保留四个备份副本，下面是每天凌晨2点备份，最大保留4个备份副本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 2 * * * bash &#x2F;opt&#x2F;etcd&#x2F;etcd_cron.sh  -c 4 -d &#x2F;opt&#x2F;etcd&#x2F; &amp;&gt;&#x2F;dev&#x2F;null</span><br></pre></td></tr></table></figure>

<h3 id="node-1"><a href="#node-1" class="headerlink" title="node"></a>node</h3><p>按照前面的做:</p>
<ul>
<li>配置系统设置</li>
<li>设置hostname</li>
<li>安装docker-ce</li>
<li>设置hosts和nginx</li>
<li>配置软件源，安装kubeadm kubelet</li>
</ul>
<p>和master的join一样，提前准备好环境和docker，然后join的时候不需要带<code>--control-plane</code>，只有一个master的话join的那个ip写<code>controlPlaneEndpoint</code>的值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node -o wide</span><br><span class="line">NAME     STATUS     ROLES    AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION          CONTAINER-RUNTIME</span><br><span class="line">k8s-m1   NotReady   master   24m   v1.18.9   172.19.0.2    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.el7.x86_64   docker://19.3.5</span><br><span class="line">k8s-m2   NotReady   master   19m   v1.18.9   172.19.0.3    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.el7.x86_64   docker://19.3.5</span><br><span class="line">k8s-m3   NotReady   master   22m   v1.18.9   172.19.0.4    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.el7.x86_64   docker://19.3.5</span><br><span class="line">k8s-n1   NotReady   &lt;none&gt;   12s   v1.18.9   172.19.0.5    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.el7.x86_64   docker://19.3.5</span><br></pre></td></tr></table></figure>

<p><code>ROLES</code>只是一个label，可以打label让其显示指定的字符串，想显示啥就<code>node-role.kubernetes.io/xxxx</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node k8s-n1 node-role.kubernetes.io/node=<span class="string">""</span></span><br></pre></td></tr></table></figure>

<h3 id="addon-此章开始到结尾选取任意一个master上执行"><a href="#addon-此章开始到结尾选取任意一个master上执行" class="headerlink" title="addon(此章开始到结尾选取任意一个master上执行)"></a>addon(此章开始到结尾选取任意一个master上执行)</h3><p>容器的网络还没处理好，coredns无法分配到ip会处于<code>pending</code>状态，这里我用flannel部署，如果你了解bgp可以使用calico<br>yaml文件来源与flannel官方github <a href="https://github.com/coreos/flannel/tree/master/Documentation" target="_blank" rel="noopener">https://github.com/coreos/flannel/tree/master/Documentation</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<h4 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h4><ul>
<li><p>如果是在1.16之前使用psp，<code>policy/v1beta1</code>得修改成<code>extensions/v1beta1</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: policy&#x2F;v1beta1</span><br><span class="line">kind: PodSecurityPolicy</span><br></pre></td></tr></table></figure></li>
<li><p>rbac的version改为下面，不要使用<code>v1beta1</code>了，使用下面命令修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -ri &#39;&#x2F;apiVersion: rbac&#x2F;s#v1.+#v1#&#39; kube-flannel.yml</span><br></pre></td></tr></table></figure>
</li>
<li><p>官方yaml自带了四种架构的daemonset，我们删掉除了amd64以外的，大概是226行到结尾，文件行数可能会变，这里我用shell取行数来删除</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NUM=`awk <span class="string">'&#123;if(/^apiVersion: apps\/v1/)&#123;a++&#125;;if(a==2)&#123;print NR;exit&#125;&#125;'</span> kube-flannel.yml`</span><br><span class="line">sed -ri <span class="variable">$NUM</span><span class="string">',$d'</span> kube-flannel.yml</span><br></pre></td></tr></table></figure>

<ul>
<li>pod的cidr修改了的话这里也要修改，如果是在同一个二层，可以使用把<code>vxlan</code>改为性能更强的<code>host-gw</code>模式,vxlan的话需要安全组放开8472端口的udp<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">net-conf.json: |</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;Network&quot;: &quot;10.244.0.0&#x2F;16&quot;,</span><br><span class="line">    &quot;Backend&quot;: &#123;</span><br><span class="line">      &quot;Type&quot;: &quot;vxlan&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<ul>
<li>这步可以先不改，如果flannel一直crash(某些版本下request和limit一样会频繁crash，实际上这种pod的优先级比较高)就修改下limits，需要大于request</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"200m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"100Mi"</span></span><br></pre></td></tr></table></figure>

<h4 id="部署flannel"><a href="#部署flannel" class="headerlink" title="部署flannel"></a>部署flannel</h4><p>1.15后node的cidr是数组，而不是单个了，在一些非最新版本部署的话会有下列错误，见文档</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.15.0/staging/src/k8s.io/api/core/v1/types.go#L3890-L3893" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/v1.15.0/staging/src/k8s.io/api/core/v1/types.go#L3890-L3893</a><br><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.6/staging/src/k8s.io/api/core/v1/types.go#L4269-L4279" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/v1.18.6/staging/src/k8s.io/api/core/v1/types.go#L4269-L4279</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error registering network: failed to acquire lease: node &quot;xxx&quot; pod cidr not assigned</span><br></pre></td></tr></table></figure>

<p>手动打patch，后续扩的node也记得打下，新版本会处理老的和新的字段的cidr值，所以下面是判断为空则patch，兼容1.15后面所有版本。如果此处写自动化部署可以根据版本看是否需要打patch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nodes=`kubectl get node --no-headers | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> <span class="variable">$nodes</span>;<span class="keyword">do</span></span><br><span class="line">    cidr=`kubectl get node <span class="string">"<span class="variable">$node</span>"</span> -o jsonpath=<span class="string">'&#123;.spec.podCIDRs[0]&#125;'</span>`</span><br><span class="line">    [ -z <span class="string">"<span class="variable">$(kubectl get node $node -o jsonpath='&#123;.spec.podCIDR&#125;')</span>"</span> ] &amp;&amp; &#123;</span><br><span class="line">        kubectl patch node <span class="string">"<span class="variable">$node</span>"</span> -p <span class="string">'&#123;"spec":&#123;"podCIDR":"'</span><span class="string">"<span class="variable">$cidr</span>"</span><span class="string">'"&#125;&#125;'</span></span><br><span class="line">    &#125; || <span class="built_in">echo</span> <span class="string">"<span class="variable">$node</span> dont't need to patch"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure>

<h2 id="验证集群可用性"><a href="#验证集群可用性" class="headerlink" title="验证集群可用性"></a>验证集群可用性</h2><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -o wide</span><br></pre></td></tr></table></figure>

<p>等待kube-system空间下的pod都是running后我们来测试下集群可用性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:alpine</span><br><span class="line">        name: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: zhangguanzhang/centos</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - sleep</span><br><span class="line">      - <span class="string">"3600"</span></span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>等待pod running</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po,svc -o wide</span></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE    IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/busybox                  1/1     Running   0          4m4s   10.244.2.18   k8s-n1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/nginx-5c559d5697-2ctxh   1/1     Running   0          4m4s   10.244.2.16   k8s-n1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE    SELECTOR</span><br><span class="line">service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   12m    &lt;none&gt;</span><br><span class="line">service/nginx        ClusterIP   10.100.39.101   &lt;none&gt;        80/TCP    4m4s   app=nginx</span><br></pre></td></tr></table></figure>

<p>验证集群dns解析</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl <span class="built_in">exec</span> -ti busybox -- nslookup kubernetes</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<p>如果不是2秒以内返回，而且是vxlan模式下不正常则看这篇文章<a href="https://zhangguanzhang.github.io/2020/05/23/k8s-vxlan-63-timeout/">k8s vxlan63秒延迟解决</a> 1.18.6,1.16.13,1.17.9已经修复这个问题了，但是如果你版本是1.17.0-1.18.5就会有这个问题，你处于<code>1.17.0-1.18.5</code>版本的话不想全部升级可以单独去切 kube-proxy 的版本例如下面</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system set image daemonset/kube-proxy *=registry.aliyuncs.com/k8sxio/kube-proxy:v1.18.6</span><br></pre></td></tr></table></figure>

<p>同样的也可以node上用dig测pod的overlay网络:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dig @10.96.0.10 +short kubernetes.default.svc.cluster.local</span></span><br><span class="line">10.96.0.1</span><br></pre></td></tr></table></figure>

<p>在master上curl nginx的svc的ip出现nginx的index内容即集群正常，例如我的nginx svc ip是<code>10.100.39.101</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -s 10.100.39.101</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>pod里验证集群域名到pod是否正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -ti busybox -- curl nginx</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;&#x2F;title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;nginx.org&#x2F;&quot;&gt;nginx.org&lt;&#x2F;a&gt;.&lt;br&#x2F;&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;nginx.com&#x2F;&quot;&gt;nginx.com&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="清理测试的pod"><a href="#清理测试的pod" class="headerlink" title="清理测试的pod"></a>清理测试的pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deploy nginx</span><br><span class="line">kubectl delete svc nginx</span><br><span class="line">kubectl delete po busybox</span><br></pre></td></tr></table></figure>

<h2 id="关于使用kubeadm的注意事项和个人建议"><a href="#关于使用kubeadm的注意事项和个人建议" class="headerlink" title="关于使用kubeadm的注意事项和个人建议"></a>关于使用kubeadm的注意事项和个人建议</h2><ul>
<li>小白不要着急啥都往上部署，例如dashboard和什么helm，没这个必要，先把命令行的kubectl和一些基础学会了</li>
<li>默认证书是只有一年的，可以自己去修改源码更改</li>
<li>先去把官方文档的concept和tasks板块看完，市面上的书籍和教程实际上都是讲的这俩板块儿</li>
<li>不懂网络的话去找点CCIE的教程看下</li>
<li>systemd和docker以及Linux基础都是挺重要的，–help找选项很多人居然都不会</li>
<li>yaml，yaml的结构就是无非那些字符，数字，object，数组的混合，可以尝试大脑中把一段yaml转换成json，不然看不懂yaml的结构学不会k8s。很多层级实际上是遵循着逻辑的，例如一个pod有多个容器，所以pod.spec.containers就是一个object的数组，又因为pod共享network namepsace，所以<code>hostNetwork</code>这个属性肯定给所有容器设置的，所以是和containers同个级别的</li>
<li>kubeconfig实际上就是存了三个信息，一个是host(集群)，用户认证信息，这些都是可以写多个的，所以都是以yaml的数组-开头，以及当前的context是哪个host搭配哪个认证信息。和web的jwt思想一样用于认证鉴权，同时一个kubeconfig可以有多个上下文来切换身份(RBAC)或者集群</li>
<li>互斥和污点都是基础知识，也在concept和tasks板块里，上生产的话多份pod肯定要互斥自己分散开来，就像没有容器技术的时代是每个节点跑一份服务，这样down了一个node业务不会挂</li>
<li>获取和操作集群资源对象不单单是kubectl，你用curl带上证书啥的也能操作集群。</li>
<li>kubectl的子命令带上-v=数字能够调试，最大是8，不同级别的log输出信息不一样，8是最详细的，同理k8s所有组件也支持<code>--log-level</code>，很多时候是排查的一个手段</li>
<li>如果不想打开网页，想查看<code>pod.spec.hostNetwork</code>字段的意思，<code>kubectl explain pod.spec.hostNetwork</code> </li>
</ul>
<p>kubeadm的master是利用 staticPod ，kubelet创建 staticPod 不需要连接 kube-apiserver 即可创建，虽然kubelet的log会一直刷连不上kube-apiserver，但是kubelet另一边也会创建管理组件和etcd的staticPod，最终kube-apiserver起来后我们就能操作集群里。staticPod也是基础知识，看到过很多人感觉从没看过官方文档，居然还问staticPod是啥</p>
<h3 id="关于kubeadm过程和更多详细参数选项见下面文章"><a href="#关于kubeadm过程和更多详细参数选项见下面文章" class="headerlink" title="关于kubeadm过程和更多详细参数选项见下面文章"></a>关于kubeadm过程和更多详细参数选项见下面文章</h3><ul>
<li><a href="https://www.jianshu.com/p/1e65610dd223" target="_blank" rel="noopener">https://www.jianshu.com/p/1e65610dd223</a></li>
</ul>
<p>其他参考:</p>
<ul>
<li><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/high-availability/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/high-availability/</a></li>
</ul>

    </article>
    <!-- license  -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="http://zhangguanzhang.github.io">Zhangguanzhang</a>
            <p>原文链接：<a href="http://zhangguanzhang.github.io/2019/11/24/kubeadm-base-use/">http://zhangguanzhang.github.io/2019/11/24/kubeadm-base-use/</a>
            <p>发表日期：<a href="http://zhangguanzhang.github.io/2019/11/24/kubeadm-base-use/">November 24th 2019, 7:36:53 pm</a>
            <p>更新日期：<a href="http://zhangguanzhang.github.io/2019/11/24/kubeadm-base-use/">September 18th 2020, 2:35:58 am</a>
            <p>版权声明：本文采用<a rel="license noopener" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href= "/2019/12/03/dos-to-gpt/" title= "从PTTYPE="dos"到TYPE="LVM2_member"的救援">
                    <div class="nextTitle">从PTTYPE="dos"到TYPE="LVM2_member"的救援</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href= "/2019/10/24/deployment-consul-in-k8s/" title= "consul仅当服务发现在k8s无状态部署使用">
                    <div class="prevTitle">consul仅当服务发现在k8s无状态部署使用</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

    <div id="lv-container" data-id="city" data-uid= MTAyMC8zMzk1OC8xMDQ5Mw>
        <script type="text/javascript">
            (function (d, s) {
                var j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') { return; }
                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>

<!-- City版安装代码已完成 -->
    
    
    <!-- gitalk评论 -->

    <!-- utteranc评论 -->

    <!-- partial('_partial/comment/changyan') -->
    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:zhangguanzhang@qq.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/zhangguanzhang" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
            
                <span class="iconfont-archer wechat" title=wechat>
                  
                  <img class="profile-qr" src="/assets/example_wc.png" />
                </span>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="/assets/zhifubao.png" class="iconfont-archer others" target="_blank" title=others></a>
            
        
    
        
            
                <a href="/atom.xml" class="iconfont-archer rss" target="_blank" title=rss></a>
            
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:50vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#事前准备-每台机器"><span class="toc-number">1.</span> <span class="toc-text">事前准备(每台机器)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#系统层面设置"><span class="toc-number">1.1.</span> <span class="toc-text">系统层面设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装docker"><span class="toc-number">1.2.</span> <span class="toc-text">安装docker</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm部署"><span class="toc-number">2.</span> <span class="toc-text">kubeadm部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装kubeadm相关"><span class="toc-number">2.1.</span> <span class="toc-text">安装kubeadm相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#master部分"><span class="toc-number">2.1.1.</span> <span class="toc-text">master部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#node"><span class="toc-number">2.1.2.</span> <span class="toc-text">node</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置kubelet的参数方法-有需要的话"><span class="toc-number">2.2.</span> <span class="toc-text">配置kubelet的参数方法(有需要的话)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置HA-所有机器-单个master跳过此步"><span class="toc-number">2.3.</span> <span class="toc-text">配置HA,所有机器(单个master跳过此步)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置集群信息-第一个master上配置"><span class="toc-number">2.4.</span> <span class="toc-text">配置集群信息(第一个master上配置)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubeadm-init"><span class="toc-number">2.5.</span> <span class="toc-text">kubeadm init</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#init-只在第一个master上面操作"><span class="toc-number">2.5.1.</span> <span class="toc-text">init(只在第一个master上面操作)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置ep的rbac"><span class="toc-number">2.5.2.</span> <span class="toc-text">设置ep的rbac</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置其他master的k8s管理组件"><span class="toc-number">2.5.3.</span> <span class="toc-text">配置其他master的k8s管理组件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#手动拷贝-某些低版本不支持上传证书的时候操作-如果前面kubeadm-init的时候加了上传证书选项这步不用执行"><span class="toc-number">2.5.3.1.</span> <span class="toc-text">手动拷贝(某些低版本不支持上传证书的时候操作,如果前面kubeadm init的时候加了上传证书选项这步不用执行)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#其他master-join进来"><span class="toc-number">2.5.3.2.</span> <span class="toc-text">其他master join进来</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#所有master配置kubectl"><span class="toc-number">2.5.4.</span> <span class="toc-text">所有master配置kubectl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#所有master配置etcd备份"><span class="toc-number">2.5.5.</span> <span class="toc-text">所有master配置etcd备份</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node-1"><span class="toc-number">2.6.</span> <span class="toc-text">node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#addon-此章开始到结尾选取任意一个master上执行"><span class="toc-number">2.7.</span> <span class="toc-text">addon(此章开始到结尾选取任意一个master上执行)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#修改"><span class="toc-number">2.7.1.</span> <span class="toc-text">修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署flannel"><span class="toc-number">2.7.2.</span> <span class="toc-text">部署flannel</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验证集群可用性"><span class="toc-number">3.</span> <span class="toc-text">验证集群可用性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#验证"><span class="toc-number">3.1.</span> <span class="toc-text">验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#清理测试的pod"><span class="toc-number">3.2.</span> <span class="toc-text">清理测试的pod</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于使用kubeadm的注意事项和个人建议"><span class="toc-number">4.</span> <span class="toc-text">关于使用kubeadm的注意事项和个人建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#关于kubeadm过程和更多详细参数选项见下面文章"><span class="toc-number">4.1.</span> <span class="toc-text">关于kubeadm过程和更多详细参数选项见下面文章</span></a></li></ol></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 89
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2020 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/20</span><a class="archive-post-title" href= "/2020/10/20/kylin-v10-k8s-overlay-error/" >银河麒麟arm64系统上k8s集群跨节点不通的一次排查</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/18</span><a class="archive-post-title" href= "/2020/09/18/ocp-4.5-install/" >openshift 4.5.9 离线安装</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/30</span><a class="archive-post-title" href= "/2020/07/30/prometheus-rate-and-irate/" >prometheus的rate与irate内部是如何计算的</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/23</span><a class="archive-post-title" href= "/2020/07/23/fs-error-fix-k8s-master/" >k8s master机器文件系统故障的一次恢复过程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/23</span><a class="archive-post-title" href= "/2020/06/23/host-gw-in-aliyun/" >阿里云上使用flannel host-gw跨节点pod不通的解决</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/19</span><a class="archive-post-title" href= "/2020/06/19/go-prom-exporter/" >[未写完]使用go开发一个Prometheus的exporter</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/23</span><a class="archive-post-title" href= "/2020/05/23/k8s-vxlan-63-timeout/" >v1.17+ k8s集群下CNI使用VXLAN模式SVC有63秒延迟的触发原因定位</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/13</span><a class="archive-post-title" href= "/2020/05/13/x86-router-flash/" >proxmox x86软路由笔记</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span><a class="archive-post-title" href= "/2020/05/12/N1-flash/" >斐讯N1刷机和旁路由的设置</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/27</span><a class="archive-post-title" href= "/2020/04/27/go-version-ifno/" >git工作流下golang项目的version信息该如何处理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/26</span><a class="archive-post-title" href= "/2020/03/26/KubeXXXMismatch/" >一次deploy,rs,sts Mismatch 的处理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/10</span><a class="archive-post-title" href= "/2020/03/10/go-mod-base-use/" >go mod的基础使用-科普</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/02</span><a class="archive-post-title" href= "/2020/03/02/centos6-hung-while-booting/" >centos6中毒重启后卡在启动页面</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/02</span><a class="archive-post-title" href= "/2020/03/02/binfmt-0000/" >记录一次request_module: runaway loop modeprobe binfmt-0000</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/27</span><a class="archive-post-title" href= "/2020/02/27/microsoft-graph-for-onedrive/" >使用microsoft-graph的api对接onedrive</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/08</span><a class="archive-post-title" href= "/2020/01/08/docker-panic-invalid-page-type/" >docker-18.06.3-ce启动panic: invalid page type: 0: 0的解决处理</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/05</span><a class="archive-post-title" href= "/2019/12/05/suse-fix-data-but-device-busy/" >opensuse的一次救援</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/03</span><a class="archive-post-title" href= "/2019/12/03/dos-to-gpt/" >从PTTYPE="dos"到TYPE="LVM2_member"的救援</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/24</span><a class="archive-post-title" href= "/2019/11/24/kubeadm-base-use/" >[长期更新]--应大多数人要求写下kubeadm的基础使用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/24</span><a class="archive-post-title" href= "/2019/10/24/deployment-consul-in-k8s/" >consul仅当服务发现在k8s无状态部署使用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/21</span><a class="archive-post-title" href= "/2019/10/21/k8s-v1.14-v1.15-fix-issue/" >手动修复v1.14-v1.15版本k8s的issue:76956</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/12</span><a class="archive-post-title" href= "/2019/10/12/boot-grub-rescue/" >/boot目录被清空下物理机无法开机的一次救援</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/11</span><a class="archive-post-title" href= "/2019/10/11/ansible-count-Idempotency/" >ansible数量限制上的幂等性</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/27</span><a class="archive-post-title" href= "/2019/09/27/consul-tls/" >高可用的SSL consul cluster实践</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/05</span><a class="archive-post-title" href= "/2019/09/05/prometheus-change-timezone/" >修改源码更改prometheus的时区问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/24</span><a class="archive-post-title" href= "/2019/08/24/gobot-build/" >gobot控制esp8266</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/06</span><a class="archive-post-title" href= "/2019/08/06/preseed/" >ubuntu preseed无人应答安装</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/14</span><a class="archive-post-title" href= "/2019/07/14/chromedp/" >golang headless browser包chromedp初探</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span><a class="archive-post-title" href= "/2019/07/08/nodeport-err/" >为什么我不用nodePort之偶然中奖几率</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/07</span><a class="archive-post-title" href= "/2019/07/07/golang-http/" >golang的net/http包的客户端简单科普</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/26</span><a class="archive-post-title" href= "/2019/06/26/uefi-pxe/" >uefi模式下docker+交换机部署pxe批量安装</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/23</span><a class="archive-post-title" href= "/2019/06/23/autoInstallServer/" >拟定excel表格服务器自动按照表格配置信息和安装的实现过程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/12</span><a class="archive-post-title" href= "/2019/06/12/CLP/" >SMASH CLP的一些笔记</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span><a class="archive-post-title" href= "/2019/06/02/cobra/" >golang cobra的一些笔记</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/28</span><a class="archive-post-title" href= "/2019/04/28/k8s-java-start-time-not-same/" >闲谈线上俩k8s环境同等limits下pod启动时间不一样解决过程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/22</span><a class="archive-post-title" href= "/2019/03/22/k8s-controller-error/" >一次kube-controller-manager的bug导致的线上无法调度处理过程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/15</span><a class="archive-post-title" href= "/2019/03/15/flannel-bin/" >不走etcd v2 api下二进制跑flannel的总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/11</span><a class="archive-post-title" href= "/2019/03/11/k8s-ha/" >k8s高可用涉及到ip填写的相关配置和一些坑</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/03</span><a class="archive-post-title" href= "/2019/03/03/kubernetes-1-13-4/" >二进制部署Kubernetes v1.13.12 HA可选</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/19</span><a class="archive-post-title" href= "/2019/02/19/jira-confluence/" >docker部署jira(8.0.0)和confluence(6.14.1)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/12</span><a class="archive-post-title" href= "/2019/02/12/dashboard/" >通用的dashboard部署和tls，SSL相关部署</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href= "/2019/01/30/fstab/" >fstab与systemd.mount自动挂载的一点研究和见解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/22</span><a class="archive-post-title" href= "/2019/01/22/proxmox-cloud-init/" >proxmox里使用cloud-init和一些笔记</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2018 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/04</span><a class="archive-post-title" href= "/2018/12/04/black-box-exporter/" >prometheus的黑盒监控</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/24</span><a class="archive-post-title" href= "/2018/11/24/how-to-use-kubeadm/" >对于初入k8s和kubeadm的一些建议</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/06</span><a class="archive-post-title" href= "/2018/11/06/onlyoffice/" >一次docker镜像的解耦--onlyoffice</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/05</span><a class="archive-post-title" href= "/2018/11/05/10chars/" >记录一次十字符病毒清理过程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/27</span><a class="archive-post-title" href= "/2018/10/27/create-kubeconfig/" >生成kubeconfig常规的两种方法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/12</span><a class="archive-post-title" href= "/2018/10/12/prometheus-operator/" >全手动部署prometheus-operator监控K8S集群以及一些坑</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/06</span><a class="archive-post-title" href= "/2018/10/06/IngressController/" >IngressController使用和它的高可用落地</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/24</span><a class="archive-post-title" href= "/2018/09/24/k8s-some-vpc-cluster/" >跨VPC或者跨云供应商搭建K8S集群正确姿势</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/18</span><a class="archive-post-title" href= "/2018/09/18/kubernetes-1-11-x-bin/" >二进制部署Kubernetes v1.11.x(1.12.x) HA可选</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/03</span><a class="archive-post-title" href= "/2018/08/03/Kubernetes_install_1.11.1/" >Kubernetes v1.11.x HA全手动苦工安装教学</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/18</span><a class="archive-post-title" href= "/2018/07/18/ecs-vip/" >基于openstack的ecs上使用VIP</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span><a class="archive-post-title" href= "/2018/07/08/travis-sync-gcr-io/" >利用travis同步gcr.io镜像到dockerhub</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/25</span><a class="archive-post-title" href= "/2018/06/25/etcd-error/" >记录一次线上k8s节点故障</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/03</span><a class="archive-post-title" href= "/2018/06/03/kubernetes-s-job/" >kubernetes's Job总结和实战以及坑</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span><a class="archive-post-title" href= "/2018/06/02/kubernetes-nodeSelector/" >kubernetes的PodAffinity的不解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/05</span><a class="archive-post-title" href= "/2018/05/05/Kubernetes_install/" >[转载+修正]Kubernetes v1.10.x HA全手动苦工安装教学</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/29</span><a class="archive-post-title" href= "/2018/04/29/kubernetes-configMap-mount/" >kubernetes的configMap文件挂载不同的路径且不覆盖目录的解决方法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/05</span><a class="archive-post-title" href= "/2018/02/05/docker-image-can-t-rm/" >docker无法删除掉镜像的解决方法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/20</span><a class="archive-post-title" href= "/2018/01/20/docker-rm%E7%9A%84%E6%B3%A8%E6%84%8F%E7%82%B9/" >慎用docker的--rm选项!!!</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/10</span><a class="archive-post-title" href= "/2018/01/10/docker%E7%9A%84%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5/" >docker的一些概念</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2017 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/24</span><a class="archive-post-title" href= "/2017/12/24/docker%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%AE%BF%E4%B8%BB%E6%9C%BA/" >docker容器访问宿主机</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/23</span><a class="archive-post-title" href= "/2017/12/23/docker%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E4%BA%92%E8%81%94/" >docker容器网络互联</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/26</span><a class="archive-post-title" href= "/2017/06/26/lua-list-all-upsteam/" >lua列出所有upsteam</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/03</span><a class="archive-post-title" href= "/2017/06/03/bash-complete/" >bash自定义补全</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/25</span><a class="archive-post-title" href= "/2017/05/25/shell%E8%84%9A%E6%9C%AC%E7%9A%84%E9%80%89%E9%A1%B9%E5%A4%84%E7%90%86/" >shell脚本的选项和参数处理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span><a class="archive-post-title" href= "/2017/05/12/ssh%E4%BA%92%E4%BF%A1/" >ssh互信</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/06</span><a class="archive-post-title" href= "/2017/05/06/shell%E5%BF%AB%E6%8D%B7%E9%94%AE%E6%8F%90%E5%8D%87%E6%95%88%E7%8E%87/" >shell利用快捷键提升命令输入和编辑</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/29</span><a class="archive-post-title" href= "/2017/04/29/zabbixsetup/" >个人zabbix安装和坑的解决</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/26</span><a class="archive-post-title" href= "/2017/04/26/%E6%AD%A3%E5%88%99%E9%9B%B6%E5%AE%BD%E6%96%AD%E8%A8%80%E7%9A%84%E4%B8%80%E4%B8%AA%E6%B3%A8%E6%84%8F%E7%82%B9/" >正则零宽断言的一个注意点</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/25</span><a class="archive-post-title" href= "/2017/04/25/%E8%BD%AC%E8%BD%BD-awk%E4%B8%ADRS-OFS-RS-ORS%E5%8C%BA%E5%88%AB%E4%BA%8E%E8%81%94%E7%B3%BB/" >[转载]awk中RS,ORS,FS,OFS区别于联系</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/20</span><a class="archive-post-title" href= "/2017/04/20/%E8%AE%B0%E5%BD%95LVM%E7%9A%84%E7%BB%83%E4%B9%A0/" >记录LVM和raid的练习</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/17</span><a class="archive-post-title" href= "/2017/04/17/iot/" >分享下自己做的外网控制硬件</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/15</span><a class="archive-post-title" href= "/2017/04/15/shell_process/" >shell多进程并发执行</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/15</span><a class="archive-post-title" href= "/2017/04/15/shellsubstring/" >shell的字符串截取</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/11</span><a class="archive-post-title" href= "/2017/04/11/8266hexdownload/" >8266模块的烧写和sdk的坑</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/09</span><a class="archive-post-title" href= "/2017/04/09/armlnmp/" >安卓安装linux并且源码编译安装搭建lnmp的坑和总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/03</span><a class="archive-post-title" href= "/2017/04/03/bond/" >centos配置bond</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/20</span><a class="archive-post-title" href= "/2017/03/20/ftp-install/" >vsftpd虚拟用户简单部署</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/15</span><a class="archive-post-title" href= "/2017/03/15/lnmp/" >源码编译安装lnmp</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/26</span><a class="archive-post-title" href= "/2017/02/26/ad/" >Altium Designer里走线开窗和挖除铺铜还有一些技巧</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/12</span><a class="archive-post-title" href= "/2017/02/12/wx00/" >微信公众号接入自己服务器</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/02</span><a class="archive-post-title" href= "/2017/02/02/lamp/" >lamp环境搭建总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/08</span><a class="archive-post-title" href= "/2017/01/08/tuling-wx/" >微信公众号接入图灵机器人api</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2016 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/13</span><a class="archive-post-title" href= "/2016/11/13/cad/" >cad</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/30</span><a class="archive-post-title" href= "/2016/10/30/20161030/" >记录下自己制作的led-vu</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/28</span><a class="archive-post-title" href= "/2016/10/28/hello/" >hello world</a>
        </li>
    
    </div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="diy"><span class="iconfont-archer">&#xe606;</span>diy</span>
    
        <span class="sidebar-tag-name" data-tags="8266"><span class="iconfont-archer">&#xe606;</span>8266</span>
    
        <span class="sidebar-tag-name" data-tags="总结"><span class="iconfont-archer">&#xe606;</span>总结</span>
    
        <span class="sidebar-tag-name" data-tags="ipmi"><span class="iconfont-archer">&#xe606;</span>ipmi</span>
    
        <span class="sidebar-tag-name" data-tags="CLP"><span class="iconfont-archer">&#xe606;</span>CLP</span>
    
        <span class="sidebar-tag-name" data-tags="k8s"><span class="iconfont-archer">&#xe606;</span>k8s</span>
    
        <span class="sidebar-tag-name" data-tags="ingress"><span class="iconfont-archer">&#xe606;</span>ingress</span>
    
        <span class="sidebar-tag-name" data-tags="Mismatch"><span class="iconfont-archer">&#xe606;</span>Mismatch</span>
    
        <span class="sidebar-tag-name" data-tags="Altium Designer"><span class="iconfont-archer">&#xe606;</span>Altium Designer</span>
    
        <span class="sidebar-tag-name" data-tags="ansible"><span class="iconfont-archer">&#xe606;</span>ansible</span>
    
        <span class="sidebar-tag-name" data-tags="consul"><span class="iconfont-archer">&#xe606;</span>consul</span>
    
        <span class="sidebar-tag-name" data-tags="lnmp"><span class="iconfont-archer">&#xe606;</span>lnmp</span>
    
        <span class="sidebar-tag-name" data-tags="安卓"><span class="iconfont-archer">&#xe606;</span>安卓</span>
    
        <span class="sidebar-tag-name" data-tags="initrd"><span class="iconfont-archer">&#xe606;</span>initrd</span>
    
        <span class="sidebar-tag-name" data-tags="grub"><span class="iconfont-archer">&#xe606;</span>grub</span>
    
        <span class="sidebar-tag-name" data-tags="raid"><span class="iconfont-archer">&#xe606;</span>raid</span>
    
        <span class="sidebar-tag-name" data-tags="Linux"><span class="iconfont-archer">&#xe606;</span>Linux</span>
    
        <span class="sidebar-tag-name" data-tags="kernel"><span class="iconfont-archer">&#xe606;</span>kernel</span>
    
        <span class="sidebar-tag-name" data-tags="prometheus"><span class="iconfont-archer">&#xe606;</span>prometheus</span>
    
        <span class="sidebar-tag-name" data-tags="exporter"><span class="iconfont-archer">&#xe606;</span>exporter</span>
    
        <span class="sidebar-tag-name" data-tags="boot"><span class="iconfont-archer">&#xe606;</span>boot</span>
    
        <span class="sidebar-tag-name" data-tags="cad"><span class="iconfont-archer">&#xe606;</span>cad</span>
    
        <span class="sidebar-tag-name" data-tags="centos6"><span class="iconfont-archer">&#xe606;</span>centos6</span>
    
        <span class="sidebar-tag-name" data-tags="golang"><span class="iconfont-archer">&#xe606;</span>golang</span>
    
        <span class="sidebar-tag-name" data-tags="chromedp"><span class="iconfont-archer">&#xe606;</span>chromedp</span>
    
        <span class="sidebar-tag-name" data-tags="cobra"><span class="iconfont-archer">&#xe606;</span>cobra</span>
    
        <span class="sidebar-tag-name" data-tags="docker"><span class="iconfont-archer">&#xe606;</span>docker</span>
    
        <span class="sidebar-tag-name" data-tags="Dockerfile"><span class="iconfont-archer">&#xe606;</span>Dockerfile</span>
    
        <span class="sidebar-tag-name" data-tags="keepavlied"><span class="iconfont-archer">&#xe606;</span>keepavlied</span>
    
        <span class="sidebar-tag-name" data-tags="etcd"><span class="iconfont-archer">&#xe606;</span>etcd</span>
    
        <span class="sidebar-tag-name" data-tags="flannel"><span class="iconfont-archer">&#xe606;</span>flannel</span>
    
        <span class="sidebar-tag-name" data-tags="cifs"><span class="iconfont-archer">&#xe606;</span>cifs</span>
    
        <span class="sidebar-tag-name" data-tags="ftp"><span class="iconfont-archer">&#xe606;</span>ftp</span>
    
        <span class="sidebar-tag-name" data-tags="go mod"><span class="iconfont-archer">&#xe606;</span>go mod</span>
    
        <span class="sidebar-tag-name" data-tags="gobot"><span class="iconfont-archer">&#xe606;</span>gobot</span>
    
        <span class="sidebar-tag-name" data-tags="esp8266"><span class="iconfont-archer">&#xe606;</span>esp8266</span>
    
        <span class="sidebar-tag-name" data-tags="http"><span class="iconfont-archer">&#xe606;</span>http</span>
    
        <span class="sidebar-tag-name" data-tags="hello world"><span class="iconfont-archer">&#xe606;</span>hello world</span>
    
        <span class="sidebar-tag-name" data-tags="mqtt"><span class="iconfont-archer">&#xe606;</span>mqtt</span>
    
        <span class="sidebar-tag-name" data-tags="原创"><span class="iconfont-archer">&#xe606;</span>原创</span>
    
        <span class="sidebar-tag-name" data-tags="jira"><span class="iconfont-archer">&#xe606;</span>jira</span>
    
        <span class="sidebar-tag-name" data-tags="confluence"><span class="iconfont-archer">&#xe606;</span>confluence</span>
    
        <span class="sidebar-tag-name" data-tags="kube-controller-manager"><span class="iconfont-archer">&#xe606;</span>kube-controller-manager</span>
    
        <span class="sidebar-tag-name" data-tags="java"><span class="iconfont-archer">&#xe606;</span>java</span>
    
        <span class="sidebar-tag-name" data-tags="springboot"><span class="iconfont-archer">&#xe606;</span>springboot</span>
    
        <span class="sidebar-tag-name" data-tags="kubeadm"><span class="iconfont-archer">&#xe606;</span>kubeadm</span>
    
        <span class="sidebar-tag-name" data-tags="ConfigMap"><span class="iconfont-archer">&#xe606;</span>ConfigMap</span>
    
        <span class="sidebar-tag-name" data-tags="PodAffinity"><span class="iconfont-archer">&#xe606;</span>PodAffinity</span>
    
        <span class="sidebar-tag-name" data-tags="lamp"><span class="iconfont-archer">&#xe606;</span>lamp</span>
    
        <span class="sidebar-tag-name" data-tags="nginx"><span class="iconfont-archer">&#xe606;</span>nginx</span>
    
        <span class="sidebar-tag-name" data-tags="microsoft"><span class="iconfont-archer">&#xe606;</span>microsoft</span>
    
        <span class="sidebar-tag-name" data-tags="graph"><span class="iconfont-archer">&#xe606;</span>graph</span>
    
        <span class="sidebar-tag-name" data-tags="onedrive"><span class="iconfont-archer">&#xe606;</span>onedrive</span>
    
        <span class="sidebar-tag-name" data-tags="nodeport"><span class="iconfont-archer">&#xe606;</span>nodeport</span>
    
        <span class="sidebar-tag-name" data-tags="preseed"><span class="iconfont-archer">&#xe606;</span>preseed</span>
    
        <span class="sidebar-tag-name" data-tags="timezone"><span class="iconfont-archer">&#xe606;</span>timezone</span>
    
        <span class="sidebar-tag-name" data-tags="operator"><span class="iconfont-archer">&#xe606;</span>operator</span>
    
        <span class="sidebar-tag-name" data-tags="openstack"><span class="iconfont-archer">&#xe606;</span>openstack</span>
    
        <span class="sidebar-tag-name" data-tags="cloud-init"><span class="iconfont-archer">&#xe606;</span>cloud-init</span>
    
        <span class="sidebar-tag-name" data-tags="linux"><span class="iconfont-archer">&#xe606;</span>linux</span>
    
        <span class="sidebar-tag-name" data-tags="shell"><span class="iconfont-archer">&#xe606;</span>shell</span>
    
        <span class="sidebar-tag-name" data-tags="bash"><span class="iconfont-archer">&#xe606;</span>bash</span>
    
        <span class="sidebar-tag-name" data-tags="ssh"><span class="iconfont-archer">&#xe606;</span>ssh</span>
    
        <span class="sidebar-tag-name" data-tags="suse"><span class="iconfont-archer">&#xe606;</span>suse</span>
    
        <span class="sidebar-tag-name" data-tags="dockerhub"><span class="iconfont-archer">&#xe606;</span>dockerhub</span>
    
        <span class="sidebar-tag-name" data-tags="gcr.io"><span class="iconfont-archer">&#xe606;</span>gcr.io</span>
    
        <span class="sidebar-tag-name" data-tags="微信"><span class="iconfont-archer">&#xe606;</span>微信</span>
    
        <span class="sidebar-tag-name" data-tags="api"><span class="iconfont-archer">&#xe606;</span>api</span>
    
        <span class="sidebar-tag-name" data-tags="tftp"><span class="iconfont-archer">&#xe606;</span>tftp</span>
    
        <span class="sidebar-tag-name" data-tags="zabbix"><span class="iconfont-archer">&#xe606;</span>zabbix</span>
    
        <span class="sidebar-tag-name" data-tags="正则"><span class="iconfont-archer">&#xe606;</span>正则</span>
    
        <span class="sidebar-tag-name" data-tags="awk"><span class="iconfont-archer">&#xe606;</span>awk</span>
    
        <span class="sidebar-tag-name" data-tags="N1"><span class="iconfont-archer">&#xe606;</span>N1</span>
    
        <span class="sidebar-tag-name" data-tags="openwrt"><span class="iconfont-archer">&#xe606;</span>openwrt</span>
    
        <span class="sidebar-tag-name" data-tags="go"><span class="iconfont-archer">&#xe606;</span>go</span>
    
        <span class="sidebar-tag-name" data-tags="63s"><span class="iconfont-archer">&#xe606;</span>63s</span>
    
        <span class="sidebar-tag-name" data-tags="timeout"><span class="iconfont-archer">&#xe606;</span>timeout</span>
    
        <span class="sidebar-tag-name" data-tags="host-gw"><span class="iconfont-archer">&#xe606;</span>host-gw</span>
    
        <span class="sidebar-tag-name" data-tags="kubeconfig"><span class="iconfont-archer">&#xe606;</span>kubeconfig</span>
    
        <span class="sidebar-tag-name" data-tags="x86"><span class="iconfont-archer">&#xe606;</span>x86</span>
    
        <span class="sidebar-tag-name" data-tags="Prometheus"><span class="iconfont-archer">&#xe606;</span>Prometheus</span>
    
        <span class="sidebar-tag-name" data-tags="openshift"><span class="iconfont-archer">&#xe606;</span>openshift</span>
    
        <span class="sidebar-tag-name" data-tags="ocp"><span class="iconfont-archer">&#xe606;</span>ocp</span>
    
        <span class="sidebar-tag-name" data-tags="Kylin"><span class="iconfont-archer">&#xe606;</span>Kylin</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br/>
    1、请确保node版本大于6.2<br/>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br/>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br/>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="日志"><span class="iconfont-archer">&#xe60a;</span>日志</span>
    
        <span class="sidebar-category-name" data-categories="ipmi"><span class="iconfont-archer">&#xe60a;</span>ipmi</span>
    
        <span class="sidebar-category-name" data-categories="kubernetes"><span class="iconfont-archer">&#xe60a;</span>kubernetes</span>
    
        <span class="sidebar-category-name" data-categories="日志/闲搞"><span class="iconfont-archer">&#xe60a;</span>日志/闲搞</span>
    
        <span class="sidebar-category-name" data-categories="日志/心得"><span class="iconfont-archer">&#xe60a;</span>日志/心得</span>
    
        <span class="sidebar-category-name" data-categories="ansible"><span class="iconfont-archer">&#xe60a;</span>ansible</span>
    
        <span class="sidebar-category-name" data-categories="pxe"><span class="iconfont-archer">&#xe60a;</span>pxe</span>
    
        <span class="sidebar-category-name" data-categories="Linux"><span class="iconfont-archer">&#xe60a;</span>Linux</span>
    
        <span class="sidebar-category-name" data-categories="prometheus"><span class="iconfont-archer">&#xe60a;</span>prometheus</span>
    
        <span class="sidebar-category-name" data-categories="boot"><span class="iconfont-archer">&#xe60a;</span>boot</span>
    
        <span class="sidebar-category-name" data-categories="kubernetes/kubelet"><span class="iconfont-archer">&#xe60a;</span>kubernetes/kubelet</span>
    
        <span class="sidebar-category-name" data-categories="日志/Auto-cad"><span class="iconfont-archer">&#xe60a;</span>日志/Auto-cad</span>
    
        <span class="sidebar-category-name" data-categories="golang"><span class="iconfont-archer">&#xe60a;</span>golang</span>
    
        <span class="sidebar-category-name" data-categories="consul"><span class="iconfont-archer">&#xe60a;</span>consul</span>
    
        <span class="sidebar-category-name" data-categories="ansible/心得"><span class="iconfont-archer">&#xe60a;</span>ansible/心得</span>
    
        <span class="sidebar-category-name" data-categories="pxe/raid"><span class="iconfont-archer">&#xe60a;</span>pxe/raid</span>
    
        <span class="sidebar-category-name" data-categories="Linux/boot"><span class="iconfont-archer">&#xe60a;</span>Linux/boot</span>
    
        <span class="sidebar-category-name" data-categories="boot/grub"><span class="iconfont-archer">&#xe60a;</span>boot/grub</span>
    
        <span class="sidebar-category-name" data-categories="Linux/centos6"><span class="iconfont-archer">&#xe60a;</span>Linux/centos6</span>
    
        <span class="sidebar-category-name" data-categories="pxe/raid/kickstart"><span class="iconfont-archer">&#xe60a;</span>pxe/raid/kickstart</span>
    
        <span class="sidebar-category-name" data-categories="Linux/centos6/boot"><span class="iconfont-archer">&#xe60a;</span>Linux/centos6/boot</span>
    
        <span class="sidebar-category-name" data-categories="日志/容器"><span class="iconfont-archer">&#xe60a;</span>日志/容器</span>
    
        <span class="sidebar-category-name" data-categories="kubernetes/docker"><span class="iconfont-archer">&#xe60a;</span>kubernetes/docker</span>
    
        <span class="sidebar-category-name" data-categories="docker"><span class="iconfont-archer">&#xe60a;</span>docker</span>
    
        <span class="sidebar-category-name" data-categories="容器"><span class="iconfont-archer">&#xe60a;</span>容器</span>
    
        <span class="sidebar-category-name" data-categories="kubernetes/docker/panic"><span class="iconfont-archer">&#xe60a;</span>kubernetes/docker/panic</span>
    
        <span class="sidebar-category-name" data-categories="openstack"><span class="iconfont-archer">&#xe60a;</span>openstack</span>
    
        <span class="sidebar-category-name" data-categories="fstab"><span class="iconfont-archer">&#xe60a;</span>fstab</span>
    
        <span class="sidebar-category-name" data-categories="vsftp"><span class="iconfont-archer">&#xe60a;</span>vsftp</span>
    
        <span class="sidebar-category-name" data-categories="gobot"><span class="iconfont-archer">&#xe60a;</span>gobot</span>
    
        <span class="sidebar-category-name" data-categories="golang/http"><span class="iconfont-archer">&#xe60a;</span>golang/http</span>
    
        <span class="sidebar-category-name" data-categories="日志/闲聊"><span class="iconfont-archer">&#xe60a;</span>日志/闲聊</span>
    
        <span class="sidebar-category-name" data-categories="kubernetes/kube-controller-manager"><span class="iconfont-archer">&#xe60a;</span>kubernetes/kube-controller-manager</span>
    
        <span class="sidebar-category-name" data-categories="kubernetes/kubeadm"><span class="iconfont-archer">&#xe60a;</span>kubernetes/kubeadm</span>
    
        <span class="sidebar-category-name" data-categories="kubernetes/k8s"><span class="iconfont-archer">&#xe60a;</span>kubernetes/k8s</span>
    
        <span class="sidebar-category-name" data-categories="kubernetes/Job"><span class="iconfont-archer">&#xe60a;</span>kubernetes/Job</span>
    
        <span class="sidebar-category-name" data-categories="lua"><span class="iconfont-archer">&#xe60a;</span>lua</span>
    
        <span class="sidebar-category-name" data-categories="microsoft"><span class="iconfont-archer">&#xe60a;</span>microsoft</span>
    
        <span class="sidebar-category-name" data-categories="preseed"><span class="iconfont-archer">&#xe60a;</span>preseed</span>
    
        <span class="sidebar-category-name" data-categories="prometheus/golang"><span class="iconfont-archer">&#xe60a;</span>prometheus/golang</span>
    
        <span class="sidebar-category-name" data-categories="kubernetes/prometheus"><span class="iconfont-archer">&#xe60a;</span>kubernetes/prometheus</span>
    
        <span class="sidebar-category-name" data-categories="proxmox"><span class="iconfont-archer">&#xe60a;</span>proxmox</span>
    
        <span class="sidebar-category-name" data-categories="日志/总结"><span class="iconfont-archer">&#xe60a;</span>日志/总结</span>
    
        <span class="sidebar-category-name" data-categories="microsoft/graph"><span class="iconfont-archer">&#xe60a;</span>microsoft/graph</span>
    
        <span class="sidebar-category-name" data-categories="microsoft/graph/onedrive"><span class="iconfont-archer">&#xe60a;</span>microsoft/graph/onedrive</span>
    
        <span class="sidebar-category-name" data-categories="boot/grub/suse"><span class="iconfont-archer">&#xe60a;</span>boot/grub/suse</span>
    
        <span class="sidebar-category-name" data-categories="CI"><span class="iconfont-archer">&#xe60a;</span>CI</span>
    
        <span class="sidebar-category-name" data-categories="pxe/docker"><span class="iconfont-archer">&#xe60a;</span>pxe/docker</span>
    
        <span class="sidebar-category-name" data-categories="日志/运维"><span class="iconfont-archer">&#xe60a;</span>日志/运维</span>
    
        <span class="sidebar-category-name" data-categories="CI/travis"><span class="iconfont-archer">&#xe60a;</span>CI/travis</span>
    
        <span class="sidebar-category-name" data-categories="日志/技巧"><span class="iconfont-archer">&#xe60a;</span>日志/技巧</span>
    
        <span class="sidebar-category-name" data-categories="日志/LVM"><span class="iconfont-archer">&#xe60a;</span>日志/LVM</span>
    
        <span class="sidebar-category-name" data-categories="pxe/docker/kickstart"><span class="iconfont-archer">&#xe60a;</span>pxe/docker/kickstart</span>
    
        <span class="sidebar-category-name" data-categories="日志/LVM/raid"><span class="iconfont-archer">&#xe60a;</span>日志/LVM/raid</span>
    
        <span class="sidebar-category-name" data-categories="golang/version"><span class="iconfont-archer">&#xe60a;</span>golang/version</span>
    
        <span class="sidebar-category-name" data-categories="k8s"><span class="iconfont-archer">&#xe60a;</span>k8s</span>
    
        <span class="sidebar-category-name" data-categories="k8s/vxlan"><span class="iconfont-archer">&#xe60a;</span>k8s/vxlan</span>
    
        <span class="sidebar-category-name" data-categories="go"><span class="iconfont-archer">&#xe60a;</span>go</span>
    
        <span class="sidebar-category-name" data-categories="go/Prometheus"><span class="iconfont-archer">&#xe60a;</span>go/Prometheus</span>
    
        <span class="sidebar-category-name" data-categories="kubeconfig"><span class="iconfont-archer">&#xe60a;</span>kubeconfig</span>
    
        <span class="sidebar-category-name" data-categories="Prometheus"><span class="iconfont-archer">&#xe60a;</span>Prometheus</span>
    
        <span class="sidebar-category-name" data-categories="k8s/Kylin"><span class="iconfont-archer">&#xe60a;</span>k8s/Kylin</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "Zhangguanzhang"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    </body>
</html>


